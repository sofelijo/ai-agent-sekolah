<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi Latihan TKA | ASKA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8fafc;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .navbar {
            background-color: #0f172a;
        }
        .navbar-brand {
            color: #fff;
            font-weight: 600;
            letter-spacing: 0.04em;
        }
        .session-wrapper {
            max-width: 980px;
            margin: 32px auto;
        }
        .session-header {
            background: #0f172a;
            color: #fff;
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 25px 50px rgba(15,23,42,0.2);
        }
        .timer {
            font-size: clamp(1.6rem, 4vw, 2.4rem);
            font-weight: 700;
        }
        .badge-pill {
            border-radius: 999px;
            padding: 4px 14px;
            font-size: 0.85rem;
        }
        .question-card {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            margin-top: 24px;
            box-shadow: 0 14px 32px rgba(15,23,42,0.08);
            border: 1px solid rgba(148,163,184,0.2);
        }
        .question-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: #475569;
            margin-bottom: 12px;
        }
        .difficulty {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.78rem;
        }
        .difficulty-easy { background: #ecfccb; color: #3f6212; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-label {
            border: 1px solid rgba(148,163,184,0.4);
            border-radius: 14px;
            padding: 14px 18px;
            display: flex;
            gap: 14px;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.15s ease, background 0.15s ease;
        }
        .option-label input {
            width: 18px;
            height: 18px;
        }
        .option-label.active {
            border-color: #2563eb;
            background: rgba(37,99,235,0.08);
        }
        .submit-panel {
            margin-top: 32px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }
        .submit-panel button {
            border: none;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: #fff;
            padding: 12px 28px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            min-width: 200px;
            transition: transform 0.15s ease;
        }
        .submit-panel button:hover {
            transform: translateY(-1px);
        }
        .hint {
            font-size: 0.9rem;
            color: #475569;
        }
    </style>
</head>
<body data-deadline="{{ deadline_iso }}" data-server-now="{{ server_time }}">
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('latihan_tka_home') }}">ASKA Â· Latihan TKA</a>
            <div>
                <a class="btn btn-outline-light btn-sm" href="{{ url_for('latihan_tka_home') }}">Ganti Mapel</a>
            </div>
        </div>
    </nav>

    <div class="session-wrapper container">
        <div class="session-header mb-4 d-flex flex-column flex-md-row justify-content-between gap-4">
            <div>
                <p class="badge-pill bg-light text-dark mb-2">Sesi Aktif</p>
                <h2 class="mb-1">{{ attempt.subject_name }}</h2>
                <p class="mb-0 text-white-50">Kerjakan 20 soal pilihan ganda dalam {{ attempt.time_limit_minutes or 15 }} menit.</p>
                {% if repeat_label %}
                <span class="badge bg-warning text-dark mt-2">{{ repeat_label }}</span>
                {% endif %}
                {% if grade_label %}
                <span class="badge bg-info text-dark mt-2">Jenjang: {{ grade_label }}</span>
                {% endif %}
                {% if preset_label and preset_label != '-' %}
                <span class="badge bg-info text-dark mt-2">Preset: {{ preset_label }}</span>
                {% endif %}
            </div>
            <div class="text-md-end">
                <div class="timer" id="countdown">15:00</div>
                <p class="mb-0">Sisa Waktu</p>
            </div>
        </div>

        <form method="post" id="quizForm">
            <input type="hidden" name="auto_reason" id="autoReason">
            {% for question in questions %}
            <section class="question-card" data-question-id="{{ question.id }}">
                <div class="question-meta">
                    <span class="badge bg-primary-subtle text-primary">Soal {{ loop.index }} / {{ questions|length }}</span>
                    <span class="difficulty difficulty-{{ question.difficulty or 'easy' }}">{{ question.difficulty|default('easy')|title }}</span>
                    {% if question.topic %}
                    <span>#{{ question.topic }}</span>
                    {% endif %}
                </div>
                <p class="fs-5">{{ question.prompt }}</p>
                <ul class="options-list">
                    {% for option in question.options %}
                    {% set option_id = "q%s_%s"|format(question.id, option.key) %}
                    <li>
                        <label class="option-label" for="{{ option_id }}">
                            <input type="radio" name="answer-{{ question.id }}" id="{{ option_id }}" value="{{ option.key }}">
                            <span class="fw-semibold">{{ option.key }}.</span>
                            <span>{{ option.text }}</span>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </section>
            {% endfor %}

            <div class="submit-panel">
                <p class="hint mb-0">Pastikan semua jawaban terisi. Jika waktunya habis, jawaban otomatis dikirim.</p>
                <button type="submit" id="submitBtn">Kirim Jawaban</button>
            </div>
        </form>
    </div>

    <script>
        (function () {
            const countdownEl = document.getElementById('countdown');
            const quizForm = document.getElementById('quizForm');
            const autoReasonInput = document.getElementById('autoReason');
            const submitBtn = document.getElementById('submitBtn');
            const optionLabels = document.querySelectorAll('.option-label');

            optionLabels.forEach(label => {
                const input = label.querySelector('input');
                input.addEventListener('change', () => {
                    const group = document.querySelectorAll(`input[name="${input.name}"]`);
                    group.forEach(el => {
                        const parent = el.closest('.option-label');
                        if (parent) parent.classList.remove('active');
                    });
                    label.classList.add('active');
                });
            });

            let autoSubmitted = false;
            const deadlineText = document.body.getAttribute('data-deadline');
            const serverNowText = document.body.getAttribute('data-server-now');
            const deadline = deadlineText ? new Date(deadlineText) : null;
            const serverNow = serverNowText ? new Date(serverNowText) : new Date();
            const offset = Date.now() - serverNow.getTime();

            function formatCountdown(ms) {
                const totalSeconds = Math.max(0, Math.floor(ms / 1000));
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return `${minutes}:${seconds}`;
            }

            function autoSubmit(reason) {
                if (autoSubmitted) return;
                autoSubmitted = true;
                autoReasonInput.value = reason || 'auto';
                submitBtn.disabled = true;
                quizForm.submit();
            }

            if (deadline) {
                const interval = setInterval(() => {
                    const now = new Date(Date.now() - offset);
                    const remaining = deadline - now;
                    if (countdownEl) {
                        countdownEl.textContent = formatCountdown(remaining);
                    }
                    if (remaining <= 0) {
                        clearInterval(interval);
                        autoSubmit('timeout');
                    }
                }, 1000);
            }

            let dirty = false;
            quizForm.addEventListener('change', () => { dirty = true; });
            window.addEventListener('beforeunload', (event) => {
                if (dirty && !autoSubmitted) {
                    event.preventDefault();
                    event.returnValue = '';
                }
            });
        })();
    </script>
</body>
</html>
