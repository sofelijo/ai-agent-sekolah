<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latihan TKA | ASKA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #f0f4ff, #e8edf9, #fff);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #0f172a;
        }
        .navbar {
            background-color: #0f172a;
        }
        .navbar-brand {
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .navbar-brand span {
            color: #4cc9f0;
        }
        .hero-card {
            background: linear-gradient(135deg, #0f172a, #1d3b7e);
            color: #fff;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 25px 60px rgba(15,23,42,0.2);
        }
        .hero-card h1 {
            font-size: clamp(1.8rem, 3vw, 2.8rem);
            margin-bottom: 1rem;
        }
        .hero-card p {
            font-size: 1rem;
            color: rgba(255,255,255,0.85);
        }
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }
        .grade-filter-group {
            display: inline-flex;
            gap: 10px;
            padding: 8px;
            border-radius: 20px;
            background: rgba(37,99,235,0.08);
        }
        .grade-filter-btn {
            border: none;
            background: transparent;
            padding: 6px 16px;
            border-radius: 999px;
            font-weight: 600;
            color: #1d4ed8;
            cursor: pointer;
        }
        .grade-filter-btn.active {
            background: #1d4ed8;
            color: #fff;
            box-shadow: 0 10px 20px rgba(29,78,216,0.3);
        }
        .subject-card {
            background: #fff;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 18px 40px rgba(15,23,42,0.08);
            border: 1px solid rgba(148,163,184,0.2);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .subject-card h3 {
            font-size: 1.2rem;
            margin: 0;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            background: #eef2ff;
            color: #312e81;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .stat-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            color: #475569;
            font-size: 0.92rem;
        }
        .stat-list li {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .start-btn {
            border: none;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: #fff;
            padding: 10px 18px;
            border-radius: 14px;
            font-weight: 600;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .start-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(37,99,235,0.25);
        }
        .empty-state {
            border: 1px dashed rgba(37,99,235,0.4);
            border-radius: 18px;
            padding: 32px;
            text-align: center;
            background: rgba(37,99,235,0.05);
            color: #1e293b;
        }
        .flash-messages {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }
        .flash-messages li {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .flash-info { background: #e0f2fe; color: #0c4a6e; }
        .flash-warning { background: #fef3c7; color: #92400e; }
        .flash-error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    {% set label_map = preset_labels or {'mudah':'Mudah','sedang':'Sedang','susah':'Susah','custom':'Kustom'} %}
    <nav class="navbar navbar-expand-lg shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <span>ASKA</span> Latihan TKA
            </a>
            <div>
                <a class="btn btn-light btn-sm" href="{{ url_for('index') }}">Kembali ke Chat</a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        {% set grade_labels = grade_labels or {'sd6': 'Kelas 6 SD', 'smp3': 'Kelas 3 SMP', 'sma': 'Kelas 3 SMA'} %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <ul class="flash-messages">
                {% for category, message in messages %}
                <li class="flash-{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        {% endwith %}

        <div class="hero-card mb-5">
            <div class="row g-4 align-items-center">
                <div class="col-lg-8">
                    <h1>Asah kemampuanmu sebelum ujian!</h1>
                    <p>
                        Setiap sesi berisi 20 soal pilihan ganda dengan durasi 15 menit. Kamu bisa memilih preset Mudah, Sedang, Susah,
                        atau mix kustom yang sudah disiapkan guru agar latihan terasa makin presisi. Setelah selesai, ASKA langsung
                        memberikan skor dan analisa kekuatan maupun area yang perlu diperbaiki.
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end text-center">
                    <div class="chip mb-3 justify-content-center">
                        ‚è±Ô∏è 15 menit &nbsp;¬∑&nbsp; 20 soal
                    </div>
                    <p class="mb-0">Latihan kapan saja, histori chat tetap tersimpan.</p>
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
            <span class="fw-semibold text-muted">Pilih jenjang:</span>
            <div class="grade-filter-group">
                <button class="grade-filter-btn active" data-grade-filter="all">Semua</button>
                <button class="grade-filter-btn" data-grade-filter="sd6">Kelas 6 SD</button>
                <button class="grade-filter-btn" data-grade-filter="smp3">Kelas 3 SMP</button>
                <button class="grade-filter-btn" data-grade-filter="sma">Kelas 3 SMA</button>
            </div>
        </div>

        {% if subjects %}
        <div class="subjects-grid">
            {% for subject in subjects %}
            {% set mix = subject.difficulty_mix or {} %}
            {% set presets = subject.difficulty_presets or {} %}
            {% set default_preset = subject.default_preset or 'mudah' %}
            {% set fallback_mix = mix or {'easy':10,'medium':5,'hard':5} %}
            <div class="subject-card" data-grade="{{ subject.grade_level or 'sd6' }}">
                <div class="d-flex justify-content-between align-items-start">
                    <h3>{{ subject.name }}</h3>
                    <span class="chip">{{ subject.question_count or 20 }} Soal</span>
                </div>
                <span class="chip bg-light text-dark">Jenjang: {{ grade_labels[subject.grade_level]|default('Kelas 6 SD') }}</span>
                <p class="mb-2 text-muted">{{ subject.description or "Soal pilihan ganda siap pakai untuk latihan intensif." }}</p>
                <ul class="stat-list">
                    <li>‚è≥ {{ subject.time_limit_minutes or 15 }} menit</li>
                    <li>üß† Analisa otomatis dari ASKA</li>
                    <li>üéØ Preset utama: {{ label_map[default_preset]|default(default_preset|title) }}</li>
                </ul>
                <form method="post" action="{{ url_for('latihan_tka_mulai', subject_id=subject.id) }}" class="mt-auto">
                    {% set preset_state = namespace(has_option=False) %}
                    <div class="mb-3">
                        <label class="form-label text-muted small">Pilih tingkat kesulitan</label>
                        <select class="form-select preset-select" name="preset" data-summary-target="mixSummary{{ subject.id }}">
                            {% for key in ['mudah','sedang','susah'] %}
                                {% set preset_mix = presets.get(key) %}
                                {% if preset_mix %}
                                    {% set preset_state.has_option = True %}
                                    {% set label = label_map[key]|default(key|title) %}
                                    <option value="{{ key }}"
                                            data-label="{{ label }}"
                                            data-easy="{{ preset_mix.easy|default(0) }}"
                                            data-medium="{{ preset_mix.medium|default(0) }}"
                                            data-hard="{{ preset_mix.hard|default(0) }}"
                                            {% if key == default_preset %}selected{% endif %}>
                                        {{ label }} ¬∑ {{ preset_mix.easy|default(0) }}M/{{ preset_mix.medium|default(0) }}S/{{ preset_mix.hard|default(0) }}H
                                    </option>
                                {% endif %}
                            {% endfor %}
                            {% for key, preset_mix in presets.items() %}
                                {% if key not in ['mudah','sedang','susah'] %}
                                    {% set preset_state.has_option = True %}
                                    {% set label = label_map[key]|default(key|title) %}
                                    <option value="{{ key }}"
                                            data-label="{{ label }}"
                                            data-easy="{{ preset_mix.easy|default(0) }}"
                                            data-medium="{{ preset_mix.medium|default(0) }}"
                                            data-hard="{{ preset_mix.hard|default(0) }}"
                                            {% if key == default_preset %}selected{% endif %}>
                                        {{ label }} ¬∑ {{ preset_mix.easy|default(0) }}M/{{ preset_mix.medium|default(0) }}S/{{ preset_mix.hard|default(0) }}H
                                    </option>
                                {% endif %}
                            {% endfor %}
                            {% if not preset_state.has_option %}
                                {% set label = label_map[default_preset]|default(default_preset|title) %}
                                <option value="{{ default_preset }}"
                                        data-label="{{ label }}"
                                        data-easy="{{ fallback_mix.easy|default(0) }}"
                                        data-medium="{{ fallback_mix.medium|default(0) }}"
                                        data-hard="{{ fallback_mix.hard|default(0) }}"
                                        selected>
                                    {{ label }} ¬∑ {{ fallback_mix.easy|default(0) }}M/{{ fallback_mix.medium|default(0) }}S/{{ fallback_mix.hard|default(0) }}H
                                </option>
                            {% endif %}
                        </select>
                        <small class="text-muted d-block mt-1" id="mixSummary{{ subject.id }}">Menyiapkan komposisi‚Ä¶</small>
                    </div>
                    <button type="submit" class="start-btn w-100">
                        Mulai Latihan
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        <div class="empty-state d-none" id="gradeEmptyState">
            <h4>Belum ada mapel untuk jenjang ini</h4>
            <p class="mb-0">Coba pilih jenjang lain atau hubungi admin untuk menambahkan bank soal baru.</p>
        </div>
        {% else %}
        <div class="empty-state">
            <h4>Mapel latihan belum tersedia</h4>
            <p class="mb-0">Admin sedang menyiapkan bank soal terbaru. Cek lagi dalam beberapa saat ya!</p>
        </div>
        {% endif %}
    </div>
    <script>
        (function () {
            const selects = document.querySelectorAll('.preset-select');
            selects.forEach(select => {
                const targetId = select.getAttribute('data-summary-target');
                const summaryEl = targetId ? document.getElementById(targetId) : null;
                if (!summaryEl) return;
                const updateSummary = () => {
                    const option = select.selectedOptions[0];
                    if (!option) return;
                    const easy = parseInt(option.dataset.easy || '0', 10);
                    const medium = parseInt(option.dataset.medium || '0', 10);
                    const hard = parseInt(option.dataset.hard || '0', 10);
                    const label = option.dataset.label || option.textContent.trim();
                    summaryEl.textContent = `${label}: ${easy} Mudah ¬∑ ${medium} Sedang ¬∑ ${hard} Susah`;
                };
                select.addEventListener('change', updateSummary);
                updateSummary();
            });

            const gradeButtons = document.querySelectorAll('[data-grade-filter]');
            const cards = document.querySelectorAll('.subject-card');
            const emptyState = document.getElementById('gradeEmptyState');
            function applyGradeFilter(value) {
                let visibleCount = 0;
                cards.forEach(card => {
                    const cardGrade = card.getAttribute('data-grade') || 'sd6';
                    const shouldShow = value === 'all' || cardGrade === value;
                    card.classList.toggle('d-none', !shouldShow);
                    if (shouldShow) visibleCount += 1;
                });
                if (emptyState) {
                    emptyState.classList.toggle('d-none', visibleCount !== 0);
                }
            }
            gradeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    gradeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    applyGradeFilter(button.getAttribute('data-grade-filter') || 'all');
                });
            });
            applyGradeFilter('all');
        })();
    </script>
</body>
</html>
