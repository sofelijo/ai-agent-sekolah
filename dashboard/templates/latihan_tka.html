{% extends "base.html" %}
{% block title %}Latihan TKA · Bank Soal{% endblock %}
{% set tka_page_mode = 'bank' %}
{% set grade_labels = grade_labels or {'sd6': 'Kelas 6 SD', 'smp3': 'Kelas 3 SMP', 'sma': 'SMA'} %}
{% set section_templates = section_templates or [
    {'key': 'matematika', 'label': 'Matematika', 'question_format': 'multiple_choice', 'subject_area': 'matematika'},
    {'key': 'bahasa_pg', 'label': 'Bahasa Indonesia · Pilihan Ganda', 'question_format': 'multiple_choice', 'subject_area': 'bahasa_indonesia'},
    {'key': 'bahasa_tf', 'label': 'Bahasa Indonesia · Benar/Salah', 'question_format': 'true_false', 'subject_area': 'bahasa_indonesia'},
] %}
{% set default_duration = default_duration or 120 %}
{% block head_extra %}
<style>
    .card { border: 1px solid var(--border-soft); border-radius: 18px; box-shadow: var(--shadow-soft); }
    .section-title { font-weight: 600; }
    .question-card { border: 1px solid var(--border-soft); border-radius: 16px; padding: 16px; margin-bottom: 16px; background: var(--bg-surface); }
    .question-card .options { list-style: none; padding-left: 1.2rem; }
    .badge-soft { border-radius: 999px; padding: 4px 10px; font-size: 0.75rem; }
    .difficulty-easy { background: #ecfccb; color: #365314; }
    .difficulty-medium { background: #fef3c7; color: #92400e; }
    .difficulty-hard { background: #fee2e2; color: #991b1b; }
    .question-card.duplicate-found { border-color: #dc2626; box-shadow: 0 0 0 1px rgba(220,38,38,0.2); }
    .question-card.duplicate-clear { border-color: #16a34a; box-shadow: 0 0 0 1px rgba(22,163,74,0.2); }
    .question-empty { border: 1px dashed var(--border-soft); border-radius: 16px; padding: 24px; text-align: center; color: var(--text-muted); }
    .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px 12px; }
    .stimulus-block { border: 1px solid var(--border-soft); border-radius: 16px; padding: 16px; background: var(--bg-surface); }
    .stimulus-block .stimulus-questions .question-card { border-style: dashed; background: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Latihan TKA · Bank Soal</h1>
            <p class="text-muted mb-0">Kini satu tes bisa punya banyak mapel dan topik; simpan komposisi per mapel (PG & Benar/Salah) tanpa metadata.</p>
        </div>
        <div class="text-end">
            <div class="text-muted small mb-2 d-flex align-items-center justify-content-end gap-2">
                <i class="bi bi-stars text-primary"></i>
                <span>ASKA Auto Generator</span>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="ASKA Auto Generator Modes">
                <a class="btn btn-outline-primary" href="{{ url_for('main.latihan_tka_generator_page', mode='lite') }}" target="_blank" rel="noopener">
                    Mode Lite
                </a>
                <a class="btn btn-outline-primary" href="{{ url_for('main.latihan_tka_generator_page', mode='pro') }}" target="_blank" rel="noopener">
                    Mode Pro
                </a>
            </div>
        </div>
    </div>

    <div id="tkaStatus" class="alert d-none" role="alert"></div>

    <div class="row g-4 align-items-start">
        <div class="col-lg-4 d-flex flex-column gap-4">
            <div class="card">
                <div class="card-header pb-0 border-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <h6 class="section-title mb-0">Daftar Tes & Jenis Latihan</h6>
                        <small class="text-muted">Data mengikuti konfigurasi tes terbaru.</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshTestSummary">
                            <i class="bi bi-arrow-repeat me-1"></i>Refresh
                        </button>
                        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.latihan_tka_tests') }}">
                            <i class="bi bi-sliders me-1"></i>Kelola Tes
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-muted small" id="testSummaryStatus">Memuat data tes...</div>
                    <div class="d-flex flex-column gap-3 mt-3" id="testSummaryList">
                        <div class="text-muted small">Menunggu data tes...</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div>
                            <h6 class="section-title mb-1">Target Mapel & Topik Tes</h6>
                            <p class="text-muted small mb-0">Sinkron dengan halaman konfigurasi tes.</p>
                        </div>
                        <div class="text-end d-flex flex-column gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshMapelTopics">
                                <i class="bi bi-arrow-repeat me-1"></i>Refresh
                            </button>
                            <a class="btn btn-link btn-sm px-0" href="{{ url_for('main.latihan_tka_tests') }}">
                                <i class="bi bi-sliders me-1"></i>Kelola Tes
                            </a>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">Total mapel terhubung: <span class="badge text-bg-light" id="mapelTotalBadge">0</span></div>
                    <div class="text-muted small mt-2" id="mapelTopicStatus">Memuat data mapel...</div>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="text-muted small">
                                <tr>
                                    <th>Mapel</th>
                                    <th>Format Soal</th>
                                    <th>Deskripsi</th>
                                    <th>Topik Terencana</th>
                                </tr>
                            </thead>
                            <tbody id="mapelTopicTableBody">
                                <tr><td colspan="4" class="text-center text-muted small">Menunggu data mapel…</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
                <div class="card p-3 h-100">
                <div class="row g-3 align-items-end mb-2">
                    <div class="col-lg-4 col-md-4">
                        <label class="form-label">Tes</label>
                        <select class="form-select" id="filterTest">
                            <option value="">Memuat daftar tes…</option>
                        </select>
                        <small class="text-muted d-block mt-1">Pilih tes untuk melihat mapel & topik.</small>
                    </div>
                    <div class="col-lg-4 col-md-4">
                        <label class="form-label">Kategori Mapel</label>
                        <select class="form-select" id="filterCategory">
                            <option value="">Memuat daftar mapel…</option>
                        </select>
                    </div>
                    <div class="col-lg-4 col-md-4">
                        <label class="form-label">Topik</label>
                        <select class="form-select" id="filterTopic" disabled>
                            <option value="">Pilih mapel terlebih dahulu</option>
                        </select>
                        <div class="d-none">
                            <select class="form-select" id="filterSubject" aria-hidden="true">
                                <option value="">Pilih tes terlebih dahulu</option>
                            </select>
                            <small class="text-muted mt-1" id="selectedGradeHint">Jenjang: <span class="badge text-bg-light" id="selectedGradeBadge">-</span></small>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="filterGrade" value="">
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <label class="form-label">Kesulitan</label>
                        <select class="form-select" id="filterDifficulty">
                            <option value="">Semua</option>
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Susah</option>
                        </select>
                    </div>
                    <div class="col-lg-6 col-md-5 col-sm-6">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-secondary" type="button" id="openPresetSettings">
                                <i class="bi bi-sliders me-1"></i>Preset kesulitan
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="openSectionSettings">
                                <i class="bi bi-grid me-1"></i>Komposisi jenis latihan
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 d-none d-lg-block d-md-block">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="text-muted small text-end">
                            <i class="bi bi-info-circle me-1"></i>Gunakan preset untuk komposisi cepat.
                        </div>
                    </div>
                </div>
                <div id="questionList"><div class="question-empty">Pilih jenis latihan untuk melihat daftar soal.</div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Soal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editQuestionForm">
                    <input type="hidden" id="editQuestionId">
                    <div class="mb-3">
                        <label class="form-label">Topik</label>
                        <input type="text" class="form-control" id="editQuestionTopic">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stimulus Cerita/Gambar</label>
                        <select class="form-select" id="editStimulusMode">
                            <option value="none" selected>Tanpa stimulus khusus</option>
                            <option value="existing">Pakai stimulus yang sudah ada</option>
                            <option value="story">Tambah cerita panjang</option>
                            <option value="image">Tambah gambar</option>
                            <option value="mixed">Cerita + gambar</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="editStimulusExistingFields">
                        <label class="form-label">Pilih stimulus</label>
                        <select class="form-select" id="editStimulusSelect"></select>
                        <small class="text-muted">Stimulus baru muncul otomatis setelah disimpan.</small>
                    </div>
                    <div class="mb-3 d-none" id="editStimulusEditorFields">
                        <label class="form-label">Judul stimulus</label>
                        <input type="text" class="form-control" id="editStimulusTitle" placeholder="Contoh: Cerita Latihan Kebun">
                        <label class="form-label mt-2">Cerita panjang</label>
                        <textarea class="form-control" id="editStimulusStory" rows="3" placeholder="Masukkan narasi atau deskripsi panjang."></textarea>
                        <label class="form-label mt-2">Unggah gambar (opsional)</label>
                        <input type="file" class="form-control" id="editStimulusImage" accept="image/*">
                        <label class="form-label mt-2">Deskripsi gambar / prompt</label>
                        <textarea class="form-control" id="editStimulusImagePrompt" rows="2" placeholder="Contoh: Ilustrasi ladang padi dengan 4 petani"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori Mapel</label>
                        <select class="form-select" id="editQuestionSection">
                            {% for section in section_templates %}
                            <option value="{{ section.key }}">{{ section.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tingkat Kesulitan</label>
                        <select class="form-select" id="editQuestionDifficulty">
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Susah</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teks Soal</label>
                        <textarea class="form-control" id="editQuestionPrompt" rows="3" required></textarea>
                    </div>
                        <label class="form-label">Pilihan Jawaban</label>
                    <div class="option-grid mb-3">
                        <div><input type="text" class="form-control" id="editOptionA" placeholder="Opsi A" required></div>
                        <div><input type="text" class="form-control" id="editOptionB" placeholder="Opsi B" required></div>
                        <div><input type="text" class="form-control" id="editOptionC" placeholder="Opsi C"></div>
                        <div><input type="text" class="form-control" id="editOptionD" placeholder="Opsi D"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jawaban Benar</label>
                        <select class="form-select" id="editQuestionAnswer">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pembahasan</label>
                        <textarea class="form-control" id="editQuestionExplain" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <span class="me-auto text-muted small" id="editStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveEditQuestion">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="difficultyConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pengaturan komposisi soal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fw-semibold" id="presetSubjectName">-</p>
                <form id="presetForm">
                    <input type="hidden" id="presetSubjectId">
                    <div class="mb-3">
                        <label class="form-label">Pilih preset:</label>
                        <div class="list-group" id="presetOptions">
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="mudah">
                                    <span>Mudah</span>
                                </span>
                                <small class="text-muted" id="presetDescMudah">-</small>
                            </label>
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="sedang">
                                    <span>Sedang</span>
                                </span>
                                <small class="text-muted" id="presetDescSedang">-</small>
                            </label>
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="susah">
                                    <span>Susah</span>
                                </span>
                                <small class="text-muted" id="presetDescSusah">-</small>
                            </label>
                            <label class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="presetOption" value="custom" id="presetCustomOption">
                                    <label class="form-check-label" for="presetCustomOption">Kustom</label>
                                </div>
                                <div class="row g-2 mt-2 d-none" id="customPresetFields">
                                    <div class="col-4">
                                        <label class="form-label">Mudah</label>
                                        <input type="number" min="0" class="form-control" id="customEasy" value="5">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Sedang</label>
                                        <input type="number" min="0" class="form-control" id="customMedium" value="5">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Susah</label>
                                        <input type="number" min="0" class="form-control" id="customHard" value="5">
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <span class="text-muted small me-auto" id="presetStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="savePresetSettings">Simpan pengaturan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sectionConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Komposisi jenis latihan & durasi tes</h5>
                    <p class="mb-0 text-muted" id="sectionSubjectName">-</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sectionSubjectId">
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Durasi tes (menit)</label>
                        <input type="number" class="form-control" id="sectionDuration" min="30" value="{{ default_duration }}">
                        <small class="text-muted">Paket TKA terbaru = 120 menit.</small>
                    </div>
                    <div class="col-md-8">
                        <div class="alert alert-info mb-0 small">
                            Bagi total 90 soal menjadi 40 Matematika serta 40 + 10 Bahasa Indonesia (PG & benar/salah). Nilai di bawah akan otomatis menjumlahkan total per kategori.
                        </div>
                    </div>
                </div>
                <div id="sectionConfigList" class="d-flex flex-column gap-3"></div>
                <div class="mt-3 text-muted small" id="sectionTotalsSummary"></div>
            </div>
            <div class="modal-footer">
                <span class="text-muted small me-auto" id="sectionConfigStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveSectionConfig">Simpan komposisi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Exporting/Viewing Content -->
<div class="modal fade" id="exportContentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="exportContentBody" class="form-control" rows="15" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="copyExportedContentBtn">
                    <i class="bi bi-clipboard me-1"></i>Copy
                </button>
            </div>
        </div>
    </div>
</div>


<script>
window.MAPEL_CACHE = window.MAPEL_CACHE || [];
document.addEventListener('DOMContentLoaded', () => {
    const SUMMARY_GRADE_LABELS = {{ grade_labels|tojson }};
    const statusBox = document.getElementById('tkaStatus');
    const testSummaryList = document.getElementById('testSummaryList');
    const testSummaryStatus = document.getElementById('testSummaryStatus');
    const refreshTestSummaryBtn = document.getElementById('refreshTestSummary');
    const mapelTableBody = document.getElementById('mapelTopicTableBody');
    const mapelStatusLabel = document.getElementById('mapelTopicStatus');
    const refreshMapelBtn = document.getElementById('refreshMapelTopics');
    const mapelTotalBadge = document.getElementById('mapelTotalBadge');

    const logError = (label, payload) => {
        try {
            console.error(`[TKA][summary][${label}]`, payload);
        } catch (_) {
            /* ignore */
        }
    };

    const showBanner = (message, tone = 'info') => {
        if (!statusBox) return;
        statusBox.className = `alert alert-${tone}`;
        statusBox.textContent = message;
        statusBox.classList.remove('d-none');
        setTimeout(() => statusBox.classList.add('d-none'), 2500);
    };

    const escapeHtml = (value = '') =>
        String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

    const setTestSummaryStatus = (message, tone = 'muted') => {
        if (!testSummaryStatus) return;
        testSummaryStatus.className = `text-${tone} small`;
        testSummaryStatus.textContent = message;
    };

    const setMapelStatus = (message, tone = 'muted') => {
        if (!mapelStatusLabel) return;
        mapelStatusLabel.className = `text-${tone} small mt-2`;
        mapelStatusLabel.textContent = message;
    };

    const normalizeNumber = (value) => {
        if (typeof value === 'number' && Number.isFinite(value)) {
            return Math.max(0, Math.round(value));
        }
        const parsed = parseInt(value, 10);
        return Number.isNaN(parsed) ? 0 : Math.max(0, parsed);
    };

    const resolveActualCount = (topic) => {
        if (!topic || typeof topic !== 'object') return 0;
        return normalizeNumber(
            topic.question_count_actual ??
            topic.question_count_current ??
            topic.question_count_ready ??
            topic.question_count_created ??
            topic.question_count ??
            topic.count ??
            topic.current
        );
    };

    const resolveTargetCount = (topic) => {
        if (!topic || typeof topic !== 'object') return 0;
        return normalizeNumber(
            topic.question_count_target ??
            topic.target ??
            topic.required ??
            topic.question_target ??
            topic.plan ??
            topic.desired ??
            topic.need ??
            0
        );
    };

    const formatTopicCoverage = (topic) => {
        const actual = resolveActualCount(topic);
        const target = resolveTargetCount(topic);
        if (!actual && !target) return '-';
        if (!target) return `${actual}`;
        let label = `${actual}/${target}`;
        if (actual > target) {
            const ratio = (actual / target).toFixed(1).replace('.', ',');
            label += ` (${ratio}x)`;
        }
        return label;
    };

    const findFormatCount = (subject, questionType) => {
        if (!subject || !Array.isArray(subject.formats)) return 0;
        const entry = subject.formats.find((fmt) => fmt.question_type === questionType);
        if (!entry) return 0;
        return normalizeNumber(entry.question_count_target ?? entry.question_count);
    };

    const findActualFormatCount = (subject, questionType) => {
        if (!subject) return 0;
        if (questionType === 'multiple_choice') {
            return normalizeNumber(subject.question_count_pg_actual || subject.pg_actual || 0);
        }
        if (questionType === 'true_false') {
            return normalizeNumber(subject.question_count_tf_actual || subject.tf_actual || 0);
        }
        return 0;
    };

    const formatCountDisplay = (actual, target) => {
        if (target && target > 0) {
            return `${actual}/${target}`;
        }
        return `${actual}`;
    };

    const buildTopicBadges = (topics) => {
        if (!Array.isArray(topics) || !topics.length) {
            return '<span class="text-muted small">Belum ada topik.</span>';
        }
        return topics
            .map((topic) => {
                const topicName = escapeHtml(topic.topic || topic.name || 'Topik');
                const coverage = formatTopicCoverage(topic);
                return `<span class="badge rounded-pill text-bg-light me-1 mb-1 d-inline-flex align-items-center gap-1">
                            <span>${topicName}</span>
                            <span class="text-primary fw-semibold">${coverage}</span>
                        </span>`;
            })
            .join('');
    };

    const buildMapelBlock = (subject) => {
        console.log('[TKA][summary] mapel payload', {
            id: subject?.id,
            mapel_id: subject?.mapel_id,
            pg_actual: subject?.question_count_pg_actual,
            tf_actual: subject?.question_count_tf_actual,
            formats: subject?.formats,
        });
        const mapelName = escapeHtml(subject.mapel_name || subject.subject_name || subject.name || 'Mapel');
        const total = normalizeNumber(subject.question_count_target || subject.total);
        const actualTotal = normalizeNumber(
            subject.question_count_actual ||
            subject.current_total ||
            subject.total_actual ||
            0
        );
        const pgTarget = findFormatCount(subject, 'multiple_choice');
        const tfTarget = findFormatCount(subject, 'true_false');
        const pgActual = findActualFormatCount(subject, 'multiple_choice');
        const tfActual = findActualFormatCount(subject, 'true_false');
        const topicBadges = buildTopicBadges(subject.topics);
        const subjectId = escapeHtml(String(subject.mapel_id || ''));
        const testSubjectId = escapeHtml(String(subject.id || subject.test_subject_id || ''));
        const mapelId = escapeHtml(String(subject.mapel_id || ''));
        const testId = escapeHtml(String(subject.test_id || subject.testId || ''));
        const gradeValue = escapeHtml(String(subject.grade_level || subject.mapel_grade_level || ''));
        return `
            <button type="button"
                    class="border rounded-3 p-2 bg-white text-start w-100 mapel-select"
                    data-mapel-select="1"
                    data-test-id="${testId}"
                    data-test-subject-id="${testSubjectId}"
                    data-subject-id="${subjectId}"
                    data-mapel-id="${mapelId}"
                    data-grade="${gradeValue}">
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="fw-semibold">${mapelName}</span>
                    <span class="text-muted">${actualTotal}/${total} soal</span>
                </div>
                <div class="text-muted small">PG ${formatCountDisplay(pgActual, pgTarget)} · BS ${formatCountDisplay(tfActual, tfTarget)}</div>
                <div class="mt-2">${topicBadges}</div>
            </button>
        `;
    };

    const formatGradeLabel = (grade) => {
        const key = (grade || '').toLowerCase();
        return SUMMARY_GRADE_LABELS[key] || (grade ? grade.toUpperCase() : 'Tanpa Jenjang');
    };

    const renderTestSummary = (tests) => {
        if (!testSummaryList) return;
        testSummaryList.innerHTML = '';
        if (!Array.isArray(tests) || !tests.length) {
            testSummaryList.innerHTML = '<div class="text-muted small">Belum ada tes tersimpan.</div>';
            return;
        }
        tests.forEach((test) => {
            const subjects = test.subjects || [];
            const mapelBlocks = subjects.length
                ? subjects.map(buildMapelBlock).join('')
                : '<div class="text-muted small">Belum ada mapel di tes ini.</div>';
            const gradeLabel = formatGradeLabel(test.grade_level);
            const duration = normalizeNumber(test.duration_minutes || test.duration);
            const wrapper = document.createElement('div');
            wrapper.className = 'border rounded-3 p-3 bg-light-subtle';
            wrapper.innerHTML = `
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                        <div class="fw-semibold">${escapeHtml(test.name || 'Tes TKA')}</div>
                        <div class="text-muted small">${duration} menit · ${gradeLabel} · ${subjects.length} mapel</div>
                    </div>
                    <span class="badge rounded-pill ${test.is_active === false ? 'text-bg-light text-muted' : 'text-bg-success-subtle text-success'}">
                        ${test.is_active === false ? 'Nonaktif' : 'Aktif'}
                    </span>
                </div>
                <div class="mt-3 d-flex flex-column gap-2">
                    ${mapelBlocks}
                </div>
            `;
            testSummaryList.appendChild(wrapper);
        });
    };

    const fetchTestSubjects = async (testId) => {
        try {
            const res = await fetch(`/latihan-tka/tests/${testId}/subjects`);
            const data = await res.json();
            if (res.ok && Array.isArray(data.subjects)) {
                return data.subjects;
            }
            logError('test-subjects-failed', { testId, status: res.status, data });
        } catch (error) {
            logError('test-subjects-error', { testId, error });
        }
        return [];
    };

    const loadTestSummary = async () => {
        if (!testSummaryList) return;
        setTestSummaryStatus('Memuat data tes...', 'muted');
        try {
            const res = await fetch('/latihan-tka/tests');
            const data = await res.json();
            if (res.ok && Array.isArray(data.tests)) {
                const enriched = await Promise.all(
                    data.tests.map(async (test) => ({
                        ...test,
                        subjects: await fetchTestSubjects(test.id),
                    }))
                );
                renderTestSummary(enriched);
                setTestSummaryStatus(`Memuat ${enriched.length} tes selesai.`, 'success');
            } else {
                logError('tests-fetch-failed', { status: res.status, data });
                setTestSummaryStatus(data.message || 'Gagal memuat data tes.', 'danger');
                showBanner(data.message || 'Gagal memuat daftar tes.', 'danger');
            }
        } catch (error) {
            logError('tests-fetch-error', error);
            setTestSummaryStatus('Terjadi kesalahan memuat tes.', 'danger');
            showBanner('Terjadi kesalahan memuat tes.', 'danger');
        }
    };

    const renderMapelTable = (mapelList) => {
        if (!mapelTableBody) return;
        mapelTableBody.innerHTML = '';
        if (!Array.isArray(mapelList) || !mapelList.length) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4" class="text-center text-muted small">Belum ada data mapel.</td>`;
            mapelTableBody.appendChild(row);
            if (mapelTotalBadge) mapelTotalBadge.textContent = '0';
            return;
        }
        if (mapelTotalBadge) mapelTotalBadge.textContent = mapelList.length;
        mapelList.forEach((mapel) => {
            const formats = (mapel.formats || []).map((fmt) => {
                const label = fmt.question_type === 'true_false' ? 'BS' : 'PG';
                return `${label} ${normalizeNumber(fmt.question_count)}`;
            }).join(' · ') || '-';
            const gradeLabel = formatGradeLabel(mapel.grade_level);
            const topics = buildTopicBadges(mapel.topics);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="fw-semibold">${escapeHtml(mapel.name || 'Mapel')}</div>
                    <div class="text-muted small">${gradeLabel}${mapel.is_active === false ? ' · Nonaktif' : ''}</div>
                </td>
                <td>${formats}</td>
                <td>${mapel.description ? `<div class="text-muted small">${escapeHtml(mapel.description)}</div>` : '<span class="text-muted small">-</span>'}</td>
                <td>${topics}</td>
            `;
            mapelTableBody.appendChild(row);
        });
    };

    const loadMapel = async () => {
        if (!mapelTableBody) return;
        setMapelStatus('Memuat data mapel...', 'muted');
        try {
            const response = await fetch('/latihan-tka/mapel');
            const data = await response.json();
            if (response.ok && data.success) {
                window.MAPEL_CACHE = data.mapel || [];
                renderMapelTable(window.MAPEL_CACHE);
                document.dispatchEvent(new CustomEvent('tka:mapel-data', {
                    detail: { mapel: window.MAPEL_CACHE.slice() },
                }));
                setMapelStatus('Data mapel berhasil dimuat.', 'success');
            } else {
                logError('mapel-fetch-failed', { status: response.status, data });
                setMapelStatus(data.message || 'Gagal memuat mapel.', 'danger');
                showBanner(data.message || 'Gagal memuat data mapel.', 'danger');
            }
        } catch (error) {
            logError('mapel-fetch-error', error);
            setMapelStatus('Terjadi kesalahan memuat mapel.', 'danger');
            showBanner('Terjadi kesalahan memuat mapel.', 'danger');
        }
    };

    if (refreshTestSummaryBtn) {
        refreshTestSummaryBtn.addEventListener('click', loadTestSummary);
    }
    if (refreshMapelBtn) {
        refreshMapelBtn.addEventListener('click', loadMapel);
    }
    if (testSummaryList) {
        testSummaryList.addEventListener('click', (event) => {
            const trigger = event.target.closest('[data-mapel-select="1"]');
            if (!trigger) return;
            event.preventDefault();
            const detail = {
                testId: trigger.dataset.testId || null,
                testSubjectId: trigger.dataset.testSubjectId || null,
                subjectId: trigger.dataset.subjectId || null,
                mapelId: trigger.dataset.mapelId || null,
                grade: trigger.dataset.grade || null,
            };
            document.dispatchEvent(new CustomEvent('tka:mapel-selected', { detail }));
        });
    }

    loadTestSummary();
    loadMapel();
});
</script>

{% block scripts %}
    {% include 'partials/latihan_tka_scripts.html' %}
{% endblock %}

{% endblock %}
