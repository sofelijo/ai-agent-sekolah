{% extends "base.html" %}
{% block title %}Latihan TKA 路 Bank Soal{% endblock %}
{% set tka_page_mode = 'bank' %}
{% set grade_labels = grade_labels or {'sd6': 'Kelas 6 SD', 'smp3': 'Kelas 3 SMP', 'sma': 'SMA'} %}
{% set section_templates = section_templates or [
    {'key': 'matematika', 'label': 'Matematika', 'question_format': 'multiple_choice', 'subject_area': 'matematika'},
    {'key': 'bahasa_pg', 'label': 'Bahasa Indonesia 路 Pilihan Ganda', 'question_format': 'multiple_choice', 'subject_area': 'bahasa_indonesia'},
    {'key': 'bahasa_tf', 'label': 'Bahasa Indonesia 路 Benar/Salah', 'question_format': 'true_false', 'subject_area': 'bahasa_indonesia'},
] %}
{% set default_duration = default_duration or 120 %}
{% block head_extra %}
<style>
    .card { border: 1px solid var(--border-soft); border-radius: 18px; box-shadow: var(--shadow-soft); }
    .section-title { font-weight: 600; }
    .question-card { border: 1px solid var(--border-soft); border-radius: 16px; padding: 16px; margin-bottom: 16px; background: var(--bg-surface); }
    .question-card .options { list-style: none; padding-left: 1.2rem; }
    .badge-soft { border-radius: 999px; padding: 4px 10px; font-size: 0.75rem; }
    .difficulty-easy { background: #ecfccb; color: #365314; }
    .difficulty-medium { background: #fef3c7; color: #92400e; }
    .difficulty-hard { background: #fee2e2; color: #991b1b; }
    .question-card.duplicate-found { border-color: #dc2626; box-shadow: 0 0 0 1px rgba(220,38,38,0.2); }
    .question-card.duplicate-clear { border-color: #16a34a; box-shadow: 0 0 0 1px rgba(22,163,74,0.2); }
    .question-empty { border: 1px dashed var(--border-soft); border-radius: 16px; padding: 24px; text-align: center; color: var(--text-muted); }
    .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px 12px; }
    .stimulus-block { border: 1px solid var(--border-soft); border-radius: 16px; padding: 16px; background: var(--bg-surface); }
    .stimulus-block .stimulus-questions .question-card { border-style: dashed; background: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Latihan TKA 路 Bank Soal</h1>
            <p class="text-muted mb-0">Kelola jenis latihan, komposisi soal, dan generate paket otomatis memakai ASKA.</p>
        </div>
        <div class="text-end">
            <div class="text-muted small mb-2 d-flex align-items-center justify-content-end gap-2">
                <i class="bi bi-stars text-primary"></i>
                <span>ASKA Auto Generator</span>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="ASKA Auto Generator Modes">
                <a class="btn btn-outline-primary" href="{{ url_for('main.latihan_tka_generator_page', mode='lite') }}" target="_blank" rel="noopener">
                    Mode Lite
                </a>
                <a class="btn btn-outline-primary" href="{{ url_for('main.latihan_tka_generator_page', mode='pro') }}" target="_blank" rel="noopener">
                    Mode Pro
                </a>
            </div>
        </div>
    </div>

    <div id="tkaStatus" class="alert d-none" role="alert"></div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header pb-0 border-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <ul class="nav nav-tabs card-header-tabs" id="formToggleTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-target="subjectFormPanel" type="button">Jenis Latihan</button>
                        </li>
                    </ul>
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.latihan_tka_manual') }}">
                        <i class="bi bi-journal-plus me-1"></i>Buat Soal Manual
                    </a>
                </div>
                <div class="card-body">
                    <div id="subjectFormPanel" class="tab-panel">
                        <p class="text-muted small">Atur 20 soal / 15 menit sesuai komposisi tingkat kesulitan.</p>
                        <form id="subjectForm" class="mt-3">
                            <div class="mb-3">
                                <label class="form-label">Nama Jenis Latihan</label>
                                <input type="text" class="form-control" id="subjectName" required placeholder="Contoh: Latihan TKA Nasional">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="subjectDesc" rows="2" placeholder="Ringkasan materi"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Jenjang</label>
                                <select class="form-select" id="subjectGrade">
                                    <option value="sd6">Kelas 6 SD</option>
                                    <option value="smp3">Kelas 3 SMP</option>
                                    <option value="sma">SMA</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Durasi (menit)</label>
                                    <input type="number" class="form-control" id="subjectTime" min="5" value="15">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="subjectActive" checked>
                                        <label class="form-check-label" for="subjectActive">Aktif</label>
                                    </div>
                                </div>
                            </div>
                            <label class="form-label">Komposisi Soal</label>
                            <div class="row">
                                <div class="col-4 mb-3">
                                    <input type="number" class="form-control" id="subjectEasy" min="0" value="10">
                                    <small class="text-muted">Mudah</small>
                                </div>
                                <div class="col-4 mb-3">
                                    <input type="number" class="form-control" id="subjectMedium" min="0" value="5">
                                    <small class="text-muted">Sedang</small>
                                </div>
                                <div class="col-4 mb-3">
                                    <input type="number" class="form-control" id="subjectHard" min="0" value="5">
                                    <small class="text-muted">Susah</small>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Tambah Jenis Latihan</button>
                        </form>
                        <div class="alert alert-light border mt-4 d-flex align-items-center justify-content-between gap-3">
                            <div>
                                <h6 class="mb-1">Tambah Soal Manual</h6>
                                <p class="text-muted small mb-0">Gunakan halaman khusus agar proses input soal lebih rapi serta ada daftar soal tersimpan.</p>
                            </div>
                            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.latihan_tka_manual') }}">
                                Buka Halaman
                            </a>
                        </div>
                    </div>
 
                </div>
            </div>
        </div>
        <div class="col-lg-8">
                <div class="card p-3 h-100">
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-lg-4 col-md-5">
                        <label class="form-label">Jenis Latihan</label>
                        <select class="form-select" id="filterSubject">
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }} ({{ grade_labels[subject.grade_level]|default('Kelas 6 SD') }})</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-1">Jenjang: <span class="badge text-bg-light" id="selectedGradeBadge">-</span></small>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-6">
                        <label class="form-label">Kategori Mapel</label>
                        <select class="form-select" id="filterCategory">
                            <option value="">Semua</option>
                            <option value="matematika">Matematika</option>
                            <option value="bahasa_indonesia">Bahasa Indonesia</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-6">
                        <label class="form-label">Tingkat Kelas</label>
                        <select class="form-select" id="filterGrade">
                            <option value="">Semua</option>
                            <option value="sd6">Kelas 6 SD</option>
                            <option value="smp3">Kelas 3 SMP</option>
                            <option value="sma">SMA</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-12">
                        <label class="form-label">Topik</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="filterTopic" placeholder="Topik">
                            <button class="btn btn-outline-primary" type="button" id="refreshQuestions" title="Muat ulang">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <label class="form-label">Kesulitan</label>
                        <select class="form-select" id="filterDifficulty">
                            <option value="">Semua</option>
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Susah</option>
                        </select>
                    </div>
                    <div class="col-lg-6 col-md-5 col-sm-6">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-secondary" type="button" id="openPresetSettings">
                                <i class="bi bi-sliders me-1"></i>Preset kesulitan
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="openSectionSettings">
                                <i class="bi bi-grid me-1"></i>Komposisi jenis latihan
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 d-none d-lg-block d-md-block">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="text-muted small text-end">
                            <i class="bi bi-info-circle me-1"></i>Gunakan preset untuk komposisi cepat.
                        </div>
                    </div>
                </div>
                <div id="questionList"><div class="question-empty">Pilih jenis latihan untuk melihat daftar soal.</div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Soal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editQuestionForm">
                    <input type="hidden" id="editQuestionId">
                    <div class="mb-3">
                        <label class="form-label">Topik</label>
                        <input type="text" class="form-control" id="editQuestionTopic">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stimulus Cerita/Gambar</label>
                        <select class="form-select" id="editStimulusMode">
                            <option value="none" selected>Tanpa stimulus khusus</option>
                            <option value="existing">Pakai stimulus yang sudah ada</option>
                            <option value="story">Tambah cerita panjang</option>
                            <option value="image">Tambah gambar</option>
                            <option value="mixed">Cerita + gambar</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="editStimulusExistingFields">
                        <label class="form-label">Pilih stimulus</label>
                        <select class="form-select" id="editStimulusSelect"></select>
                        <small class="text-muted">Stimulus baru muncul otomatis setelah disimpan.</small>
                    </div>
                    <div class="mb-3 d-none" id="editStimulusEditorFields">
                        <label class="form-label">Judul stimulus</label>
                        <input type="text" class="form-control" id="editStimulusTitle" placeholder="Contoh: Cerita Latihan Kebun">
                        <label class="form-label mt-2">Cerita panjang</label>
                        <textarea class="form-control" id="editStimulusStory" rows="3" placeholder="Masukkan narasi atau deskripsi panjang."></textarea>
                        <label class="form-label mt-2">Unggah gambar (opsional)</label>
                        <input type="file" class="form-control" id="editStimulusImage" accept="image/*">
                        <label class="form-label mt-2">Deskripsi gambar / prompt</label>
                        <textarea class="form-control" id="editStimulusImagePrompt" rows="2" placeholder="Contoh: Ilustrasi ladang padi dengan 4 petani"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori Mapel</label>
                        <select class="form-select" id="editQuestionSection">
                            {% for section in section_templates %}
                            <option value="{{ section.key }}">{{ section.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tingkat Kesulitan</label>
                        <select class="form-select" id="editQuestionDifficulty">
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Susah</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teks Soal</label>
                        <textarea class="form-control" id="editQuestionPrompt" rows="3" required></textarea>
                    </div>
                        <label class="form-label">Pilihan Jawaban</label>
                    <div class="option-grid mb-3">
                        <div><input type="text" class="form-control" id="editOptionA" placeholder="Opsi A" required></div>
                        <div><input type="text" class="form-control" id="editOptionB" placeholder="Opsi B" required></div>
                        <div><input type="text" class="form-control" id="editOptionC" placeholder="Opsi C"></div>
                        <div><input type="text" class="form-control" id="editOptionD" placeholder="Opsi D"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jawaban Benar</label>
                        <select class="form-select" id="editQuestionAnswer">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pembahasan</label>
                        <textarea class="form-control" id="editQuestionExplain" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <span class="me-auto text-muted small" id="editStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveEditQuestion">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="difficultyConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pengaturan komposisi soal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fw-semibold" id="presetSubjectName">-</p>
                <form id="presetForm">
                    <input type="hidden" id="presetSubjectId">
                    <div class="mb-3">
                        <label class="form-label">Pilih preset:</label>
                        <div class="list-group" id="presetOptions">
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="mudah">
                                    <span>Mudah</span>
                                </span>
                                <small class="text-muted" id="presetDescMudah">-</small>
                            </label>
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="sedang">
                                    <span>Sedang</span>
                                </span>
                                <small class="text-muted" id="presetDescSedang">-</small>
                            </label>
                            <label class="list-group-item d-flex justify-content-between align-items-start">
                                <span>
                                    <input class="form-check-input me-2" type="radio" name="presetOption" value="susah">
                                    <span>Susah</span>
                                </span>
                                <small class="text-muted" id="presetDescSusah">-</small>
                            </label>
                            <label class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="presetOption" value="custom" id="presetCustomOption">
                                    <label class="form-check-label" for="presetCustomOption">Kustom</label>
                                </div>
                                <div class="row g-2 mt-2 d-none" id="customPresetFields">
                                    <div class="col-4">
                                        <label class="form-label">Mudah</label>
                                        <input type="number" min="0" class="form-control" id="customEasy" value="5">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Sedang</label>
                                        <input type="number" min="0" class="form-control" id="customMedium" value="5">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Susah</label>
                                        <input type="number" min="0" class="form-control" id="customHard" value="5">
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <span class="text-muted small me-auto" id="presetStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="savePresetSettings">Simpan pengaturan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sectionConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Komposisi jenis latihan & durasi tes</h5>
                    <p class="mb-0 text-muted" id="sectionSubjectName">-</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sectionSubjectId">
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Durasi tes (menit)</label>
                        <input type="number" class="form-control" id="sectionDuration" min="30" value="{{ default_duration }}">
                        <small class="text-muted">Paket TKA terbaru = 120 menit.</small>
                    </div>
                    <div class="col-md-8">
                        <div class="alert alert-info mb-0 small">
                            Bagi total 90 soal menjadi 40 Matematika serta 40 + 10 Bahasa Indonesia (PG & benar/salah). Nilai di bawah akan otomatis menjumlahkan total per kategori.
                        </div>
                    </div>
                </div>
                <div id="sectionConfigList" class="d-flex flex-column gap-3"></div>
                <div class="mt-3 text-muted small" id="sectionTotalsSummary"></div>
            </div>
            <div class="modal-footer">
                <span class="text-muted small me-auto" id="sectionConfigStatus"></span>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveSectionConfig">Simpan komposisi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Exporting/Viewing Content -->
<div class="modal fade" id="exportContentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="exportContentBody" class="form-control" rows="15" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="copyExportedContentBtn">
                    <i class="bi bi-clipboard me-1"></i>Copy
                </button>
            </div>
        </div>
    </div>
</div>


{% block scripts %}
    {% include 'partials/latihan_tka_scripts.html' %}
{% endblock %}

{% endblock %}
