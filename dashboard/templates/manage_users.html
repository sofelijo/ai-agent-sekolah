{% extends 'base.html' %}
{% block title %}Manajemen User - ASKA Insights{% endblock %}

{% block content %}
<section class="page-header">
    <div class="page-title-group">
        <span class="icon-badge feature-icon text-primary">
            <i class="bi bi-people"></i>
        </span>
        <div>
            <h1 class="h4 fw-bold page-title mb-0">Manajemen User</h1>
            <p class="page-subtitle">Tambahkan anggota tim dan kelola hak akses dashboard ASKA.</p>
        </div>
    </div>
</section>

<div class="row g-4 user-management-layout">
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column gap-3">
                <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
                    <div class="d-flex align-items-center gap-3">
                        <span class="icon-badge section-icon text-primary">
                            <i class="bi bi-person-plus"></i>
                        </span>
                        <div>
                            <h2 id="userFormTitle" class="h5 fw-bold mb-0">Tambah User Dashboard</h2>
                            <p class="page-subtitle small mb-0">Klik user di tabel untuk mengedit data.</p>
                        </div>
                    </div>
                    <span id="userFormMode" class="badge text-bg-info text-uppercase">Mode: Tambah</span>
                </div>
                <form
                    id="userForm"
                    method="post"
                    data-create-url="{{ url_for('auth.manage_users') }}"
                    data-update-url="{{ url_for('auth.update_user', user_id=0) }}"
                >
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="full_name" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Password</label>
                            <input id="passwordInput" type="password" class="form-control" name="password" minlength="8" required>
                            <small id="passwordHelp" class="text-muted">Minimal 8 karakter.</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Role</label>
                            <select class="form-select" name="role" required>
                                <option value="viewer">Viewer</option>
                                <option value="editor">Editor</option>
                                <option value="staff">Staff</option>
                                <option value="ekskul">Ekskul</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="text-muted small">Detail tambahan (opsional)</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Jabatan</label>
                            <input type="text" class="form-control" name="jabatan">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">NIP</label>
                            <input type="text" class="form-control" name="nip">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">NRK</label>
                            <input type="text" class="form-control" name="nrk">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Gelar Depan</label>
                            <input type="text" class="form-control" name="degree_prefix">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Gelar Belakang</label>
                            <input type="text" class="form-control" name="degree_suffix">
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-save me-2"></i><span id="userFormSubmitLabel">Simpan</span>
                        </button>
                        <button type="button" id="cancelEditBtn" class="btn btn-light d-none">Batal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column gap-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div class="d-flex align-items-center gap-3">
                        <span class="icon-badge section-icon text-secondary">
                            <i class="bi bi-card-list"></i>
                        </span>
                        <div>
                            <h2 class="h5 fw-bold mb-0">Daftar User</h2>
                            <p class="page-subtitle small mb-0">Gunakan pencarian untuk menemukan user dengan cepat.</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 ms-auto flex-wrap">
                        <div class="input-group input-group-sm user-search">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="userSearch"
                                placeholder="Cari nama, email, role, jabatan...">
                        </div>
                        <span id="userCount" class="badge text-bg-secondary">0 user</span>
                    </div>
                </div>
                <div class="user-table-shell table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Jabatan &amp; ID</th>
                                <th>Dibuat / Login</th>
                                <th class="text-end">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            {% set search_blob = (user.full_name ~ ' ' ~ user.email ~ ' ' ~ user.role ~ ' ' ~ (user.jabatan or '') ~ ' ' ~ (user.nip or '') ~ ' ' ~ (user.nrk or '')) | lower %}
                            {% set role_badge = 'text-bg-danger' if user.role == 'admin' else 'text-bg-primary' if user.role == 'staff' else 'text-bg-info' if user.role == 'ekskul' else 'text-bg-secondary' %}
                            <tr data-user-row data-search="{{ search_blob }}">
                                <td>
                                    <div class="fw-semibold">{{ user.full_name }}</div>
                                    <div class="text-muted small">{{ user.email }}</div>
                                </td>
                                <td>
                                    <span class="badge {{ role_badge }} text-uppercase">{{ user.role }}</span>
                                </td>
                                <td>
                                    <div class="small">{{ user.jabatan or '-' }}</div>
                                    <div class="text-muted small">NIP: {{ user.nip or '-' }} | NRK: {{ user.nrk or '-' }}</div>
                                </td>
                                <td>
                                    <div class="small">Dibuat: {{ user.created_at|jakarta('%d %b %Y %H:%M') if user.created_at else '-' }}</div>
                                    <div class="text-muted small">Login: {{ user.last_login_at|jakarta('%d %b %Y %H:%M') if user.last_login_at else '-' }}</div>
                                </td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-2">
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-primary js-edit-user"
                                            data-user-id="{{ user.id }}"
                                            data-full-name="{{ user.full_name }}"
                                            data-email="{{ user.email }}"
                                            data-role="{{ user.role }}"
                                            data-jabatan="{{ user.jabatan or '' }}"
                                            data-nip="{{ user.nip or '' }}"
                                            data-nrk="{{ user.nrk or '' }}"
                                            data-degree-prefix="{{ user.degree_prefix or '' }}"
                                            data-degree-suffix="{{ user.degree_suffix or '' }}"
                                        >
                                            <i class="bi bi-pencil me-1"></i>Edit
                                        </button>
                                        <form method="post" action="{{ url_for('auth.delete_user', user_id=user.id) }}"
                                            onsubmit="return confirm('Hapus user ini?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash me-1"></i>Hapus
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Belum ada user.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const form = document.getElementById('userForm');
    if (!form) return;

    const createUrl = form.dataset.createUrl;
    const updateUrlTemplate = form.dataset.updateUrl;
    const titleEl = document.getElementById('userFormTitle');
    const modeEl = document.getElementById('userFormMode');
    const submitLabel = document.getElementById('userFormSubmitLabel');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const passwordInput = document.getElementById('passwordInput');
    const passwordHelp = document.getElementById('passwordHelp');

    const setCreateMode = () => {
        form.action = createUrl;
        form.dataset.mode = 'create';
        if (titleEl) titleEl.textContent = 'Tambah User Dashboard';
        if (modeEl) {
            modeEl.textContent = 'Mode: Tambah';
            modeEl.className = 'badge text-bg-info text-uppercase';
        }
        if (submitLabel) submitLabel.textContent = 'Simpan';
        if (cancelBtn) cancelBtn.classList.add('d-none');
        if (passwordInput) {
            passwordInput.required = true;
            passwordInput.value = '';
            passwordInput.placeholder = 'Minimal 8 karakter';
        }
        if (passwordHelp) passwordHelp.textContent = 'Minimal 8 karakter.';
        form.reset();
    };

    const setEditMode = (payload) => {
        form.action = updateUrlTemplate.replace('/0/', `/${payload.id}/`);
        form.dataset.mode = 'edit';
        if (titleEl) titleEl.textContent = 'Edit User';
        if (modeEl) {
            modeEl.textContent = 'Mode: Edit';
            modeEl.className = 'badge text-bg-warning text-uppercase';
        }
        if (submitLabel) submitLabel.textContent = 'Simpan Perubahan';
        if (cancelBtn) cancelBtn.classList.remove('d-none');
        if (passwordInput) {
            passwordInput.required = false;
            passwordInput.value = '';
            passwordInput.placeholder = 'Kosongkan jika tidak diubah';
        }
        if (passwordHelp) passwordHelp.textContent = 'Kosongkan jika tidak diubah.';

        form.querySelector('[name="full_name"]').value = payload.fullName || '';
        form.querySelector('[name="email"]').value = payload.email || '';
        form.querySelector('[name="role"]').value = payload.role || 'viewer';
        form.querySelector('[name="jabatan"]').value = payload.jabatan || '';
        form.querySelector('[name="nip"]').value = payload.nip || '';
        form.querySelector('[name="nrk"]').value = payload.nrk || '';
        form.querySelector('[name="degree_prefix"]').value = payload.degreePrefix || '';
        form.querySelector('[name="degree_suffix"]').value = payload.degreeSuffix || '';

        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    document.querySelectorAll('.js-edit-user').forEach((btn) => {
        btn.addEventListener('click', () => {
            setEditMode({
                id: btn.dataset.userId,
                fullName: btn.dataset.fullName,
                email: btn.dataset.email,
                role: btn.dataset.role,
                jabatan: btn.dataset.jabatan,
                nip: btn.dataset.nip,
                nrk: btn.dataset.nrk,
                degreePrefix: btn.dataset.degreePrefix,
                degreeSuffix: btn.dataset.degreeSuffix,
            });
        });
    });

    if (cancelBtn) {
        cancelBtn.addEventListener('click', setCreateMode);
    }

    const searchInput = document.getElementById('userSearch');
    const rows = Array.from(document.querySelectorAll('[data-user-row]'));
    const countEl = document.getElementById('userCount');

    const updateCount = () => {
        if (!countEl) return;
        const visible = rows.filter((row) => !row.classList.contains('d-none')).length;
        countEl.textContent = `${visible} user`;
    };

    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            rows.forEach((row) => {
                const haystack = row.dataset.search || '';
                row.classList.toggle('d-none', query && !haystack.includes(query));
            });
            updateCount();
        });
    }

    updateCount();
})();
</script>
{% endblock %}
