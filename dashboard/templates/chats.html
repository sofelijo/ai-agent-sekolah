{% extends 'base.html' %}
{% block title %}Chat Logs - ASKA Insights{% endblock %}

{% block content %}
<section class="page-header">
    <div class="page-title-group">
        <span class="icon-badge feature-icon text-primary">
            <i class="bi bi-chat-left-text"></i>
        </span>
        <div>
            <h1 class="h3 fw-bold page-title mb-0">Chat Logs</h1>
            <p class="page-subtitle">Telusuri percakapan, filter berdasarkan tanggal atau kata kunci, dan ekspor bila diperlukan.</p>
        </div>
    </div>
    <div class="page-header-actions">
        <a class="btn btn-outline-primary" href="{{ export_url }}">
            <i class="bi bi-download me-2"></i>Export CSV
        </a>
    </div>
</section>

<form class="row g-3 mb-4" method="get">
    <div class="col-md-3">
        <label class="form-label">Tanggal Mulai</label>
        <input type="date" class="form-control" name="start" value="{{ filters.start.strftime('%Y-%m-%d') if filters.start }}">
    </div>
    <div class="col-md-3">
        <label class="form-label">Tanggal Selesai</label>
        <input type="date" class="form-control" name="end" value="{{ filters.end.strftime('%Y-%m-%d') if filters.end }}">
    </div>
    <div class="col-md-2">
        <label class="form-label">Role</label>
        <select class="form-select" name="role">
            <option value="">Semua</option>
            <option value="user" {% if filters.role == 'user' %}selected{% endif %}>User</option>
            <option value="aska" {% if filters.role == 'aska' %}selected{% endif %}>ASKA</option>
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">User ID</label>
        <input type="number" class="form-control" name="user_id" value="{{ filters.user_id or '' }}">
    </div>
    <div class="col-md-2">
        <label class="form-label">Cari</label>
        <input type="text" class="form-control" name="search" placeholder="Kata kunci" value="{{ filters.search or '' }}">
    </div>
    <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-filter-circle me-2"></i>Terapkan Filter
        </button>
        <a href="{{ url_for('main.chats') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
        </a>
    </div>
</form>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 120px;"><i class="bi bi-clock-history"></i>Waktu</th>
                        <th scope="col" style="width: 110px;"><i class="bi bi-person-bounding-box"></i>User ID</th>
                        <th scope="col" style="width: 110px;"><i class="bi bi-robot"></i>Role</th>
                        <th scope="col"><i class="bi bi-chat-text"></i>Pesan</th>
                        <th scope="col" style="width: 130px;"><i class="bi bi-speedometer2"></i>Response (ms)</th>
                        <th scope="col" style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr>
                        <td><span class="badge text-bg-light">{{ row.created_at|jakarta('%d %b %Y %H:%M') }}</span></td>
                        <td class="fw-semibold">{{ row.user_id }}</td>
                        <td>
                            {% if row.role == 'aska' %}
                                <span class="badge rounded-pill text-bg-primary">ASKA</span>
                            {% else %}
                                <span class="badge rounded-pill text-bg-secondary">User</span>
                            {% endif %}
                        </td>
                        <td style="white-space: pre-line; max-width: 520px;">{{ row.text }}</td>
                        <td>{{ row.response_time_ms or '-' }}</td>
                        <td>
                            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.chat_thread', user_id=row.user_id) }}" title="Lihat thread">
                                <i class="bi bi-arrow-up-right-square me-1"></i>Detail
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">Tidak ada data sesuai filter.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<nav class="mt-3" aria-label="Pagination">
    <ul class="pagination justify-content-end">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.chats', page=page-1, start=request.args.get('start'), end=request.args.get('end'), role=request.args.get('role'), search=request.args.get('search'), user_id=request.args.get('user_id')) }}">Previous</a>
        </li>
        <li class="page-item disabled"><span class="page-link">Halaman {{ page }} / {{ total_pages }}</span></li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.chats', page=page+1, start=request.args.get('start'), end=request.args.get('end'), role=request.args.get('role'), search=request.args.get('search'), user_id=request.args.get('user_id')) }}">Next</a>
        </li>
    </ul>
</nav>
{% endblock %}
