{% extends 'base.html' %}
{% block title %}Twitter Ops Center - ASKA Insights{% endblock %}

{% block head_extra %}
<style>
    .page-header-actions { gap: 0.5rem; }
    .metric-card { min-height: 160px; }
    .metric-card .stat-label { text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.75rem; }
    .metric-card .stat-primary { font-size: clamp(1.8rem, 1.6rem + 1vw, 2.6rem); font-weight: 700; }
    .metric-card .stat-detail { font-size: 0.85rem; color: var(--text-muted); }
    .runtime-card ul { list-style: none; padding: 0; margin: 0; }
    .runtime-card li + li { margin-top: 0.45rem; }
    .runtime-card .status-dot { width: 0.7rem; height: 0.7rem; border-radius: 50%; display: inline-block; margin-right: 0.4rem; }
    .log-table td { white-space: pre-line; vertical-align: top; }
    .log-badge { font-size: 0.75rem; }
    .range-chip-group .btn { border-radius: 999px; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.04em; }
    .range-chip-group .btn.active { color: #fff; }
    .autopost-preview li { border-left: 3px solid var(--accent, #0d6efd); padding-left: 0.75rem; margin-bottom: 0.75rem; }
    .autopost-preview li:last-child { margin-bottom: 0; }
    .autopost-preview .badge { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .chart-container { position: relative; height: 300px; }
    .log-level-badge { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .log-context { font-size: 0.8rem; color: var(--text-muted); }
    .console-log-table-wrapper { max-height: 420px; overflow: auto; }
    .log-row-autopost { background: rgba(13, 110, 253, 0.06); }
    .log-row-autopost td { border-top-color: rgba(13, 110, 253, 0.12); }
    @media (max-width: 576px) {
        .metric-card { min-height: auto; }
        .page-header-actions { width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<section class="page-header mb-4">
    <div class="page-title-group">
        <span class="icon-badge feature-icon text-primary">
            <i class="bi bi-twitter"></i>
        </span>
        <div>
            <h1 class="h3 fw-bold page-title mb-0">Twitter Ops Center</h1>
            <p class="page-subtitle mb-0">Pantau performa worker X/Twitter: mention masuk, balasan otomatis, status autopost, dan anomali.</p>
        </div>
    </div>
    <div class="page-header-actions d-flex flex-wrap justify-content-end">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.twitter_logs') }}" title="Reset filter">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
        </a>
        {% if export_url %}
        <a class="btn btn-outline-primary btn-sm" href="{{ export_url }}">
            <i class="bi bi-download me-1"></i>Export CSV
        </a>
        {% endif %}
    </div>
</section>

{% if not topic_supported %}
<div class="alert alert-warning border-warning-subtle d-flex align-items-center gap-2">
    <i class="bi bi-exclamation-triangle-fill fs-5"></i>
    <div>
        <strong>Kolom <code>topic</code> belum tersedia pada tabel <code>chat_logs</code>.</strong>
        <div class="small mb-0">Tambahkan kolom tersebut atau jalankan migrasi terbaru agar log Twitter dapat dipisahkan dari chat lain.</div>
    </div>
</div>
{% endif %}

{% set start_value = filters.start|jakarta('%Y-%m-%d') if filters.start else '' %}
{% set end_value = filters.end|jakarta('%Y-%m-%d') if filters.end else '' %}

<form class="card border-0 shadow-sm mb-4" method="get">
    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
            <div>
                <span class="icon-badge section-icon text-primary">
                    <i class="bi bi-funnel"></i>
                </span>
                <strong class="ms-2 text-uppercase small text-muted">Filter Log</strong>
            </div>
            <div class="btn-group btn-group-sm range-chip-group" role="group" aria-label="Rentang cepat">
                <a class="btn btn-outline-secondary {% if selected_range == 'all' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='all', role=filters.role, search=filters.search, user_id=filters.user_id) }}">Semua</a>
                <a class="btn btn-outline-secondary {% if selected_range == 'today' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='today', role=filters.role, search=filters.search, user_id=filters.user_id) }}">Hari Ini</a>
                <a class="btn btn-outline-secondary {% if selected_range == '24h' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='24h', role=filters.role, search=filters.search, user_id=filters.user_id) }}">24 Jam</a>
                <a class="btn btn-outline-secondary {% if selected_range == '7d' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='7d', role=filters.role, search=filters.search, user_id=filters.user_id) }}">7 Hari</a>
                <a class="btn btn-outline-secondary {% if selected_range == '30d' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='30d', role=filters.role, search=filters.search, user_id=filters.user_id) }}">30 Hari</a>
                <a class="btn btn-outline-secondary {% if selected_range == '90d' %}active{% endif %}" href="{{ url_for('main.twitter_logs', range='90d', role=filters.role, search=filters.search, user_id=filters.user_id) }}">90 Hari</a>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Tanggal Mulai</label>
                <input type="date" class="form-control" name="start" value="{{ start_value }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Tanggal Selesai</label>
                <input type="date" class="form-control" name="end" value="{{ end_value }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Role</label>
                <select class="form-select" name="role">
                    <option value="">Semua</option>
                    <option value="user" {% if filters.role == 'user' %}selected{% endif %}>Mention</option>
                    <option value="aska" {% if filters.role == 'aska' %}selected{% endif %}>Balasan</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">User ID</label>
                <input type="number" class="form-control" name="user_id" value="{{ filters.user_id or '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Cari</label>
                <input type="text" class="form-control" name="search" placeholder="Kata kunci" value="{{ filters.search or '' }}">
            </div>
        </div>
        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-sliders2-vertical me-2"></i>Terapkan
            </button>
            <a class="btn btn-outline-secondary" href="{{ url_for('main.twitter_logs') }}">
                <i class="bi bi-eraser-fill me-2"></i>Bersihkan
            </a>
        </div>
    </div>
</form>

<div class="row g-3 mb-3">
    <div class="col-xxl-3 col-lg-6 col-sm-6">
        <div class="card metric-card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="stat-label text-secondary fw-semibold">Mention Masuk</span>
                    <span class="icon-badge stat-icon text-primary">
                        <i class="bi bi-chat-left-quote"></i>
                    </span>
                </div>
                <div class="stat-primary">{{ overview.total_mentions }}</div>
                <div class="d-flex gap-3 stat-detail mt-2">
                    <span><i class="bi bi-clock-history me-1"></i>24h: {{ overview.mentions_24h }}</span>
                    <span><i class="bi bi-calendar-event me-1"></i>{{ overview.window_days }} hari: {{ overview.mentions_window }}</span>
                </div>
                <div class="stat-detail mt-1">
                    <i class="bi bi-calendar-day me-1"></i>Hari ini: {{ overview.mentions_today }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-lg-6 col-sm-6">
        <div class="card metric-card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="stat-label text-secondary fw-semibold">Balasan ASKA</span>
                    <span class="icon-badge stat-icon text-success">
                        <i class="bi bi-arrow-repeat"></i>
                    </span>
                </div>
                <div class="stat-primary">{{ overview.total_replies }}</div>
                <div class="stat-detail mt-2">
                    <i class="bi bi-activity me-1"></i>Coverage {{ (overview.reply_rate * 100)|round(1) }}%
                    <span class="ms-2">
                        {% if overview.backlog > 0 %}
                        <span class="badge text-bg-danger-subtle border border-danger-subtle">Backlog {{ overview.backlog }}</span>
                        {% else %}
                        <span class="badge text-bg-success-subtle border border-success-subtle">0 backlog</span>
                        {% endif %}
                    </span>
                </div>
                <div class="stat-detail mt-1">
                    <i class="bi bi-clock-history me-1"></i>24h: {{ overview.replies_24h }}
                    <span class="ms-2"><i class="bi bi-calendar-day me-1"></i>Hari ini: {{ overview.replies_today }}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-lg-6 col-sm-6">
        <div class="card metric-card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="stat-label text-secondary fw-semibold">Autopost ASKA</span>
                    <span class="icon-badge stat-icon text-info">
                        <i class="bi bi-megaphone"></i>
                    </span>
                </div>
                <div class="stat-primary">{{ overview.autopost_total }}</div>
                <div class="stat-detail mt-2">
                    <i class="bi bi-clock-history me-1"></i>24h: {{ overview.autopost_24h }}
                    <span class="ms-2"><i class="bi bi-calendar-event me-1"></i>{{ overview.window_days }} hari: {{ overview.autopost_window }}</span>
                </div>
                <div class="stat-detail mt-1">
                    <i class="bi bi-calendar-day me-1"></i>Hari ini: {{ overview.autopost_today }}
                </div>
                {% if overview.last_autopost %}
                <div class="stat-detail mt-2">
                    <i class="bi bi-clock me-1"></i>Autopost terakhir {{ overview.last_autopost.created_at|jakarta('%d %b %Y %H:%M') }}
                </div>
                <div class="stat-detail text-muted small">
                    <i class="bi bi-chat-quote me-1"></i>{{ overview.last_autopost.text|default('', true)|replace('\n', ' ')|truncate(70) }}
                </div>
                {% else %}
                <div class="stat-detail mt-2 text-muted">
                    <i class="bi bi-megaphone-off me-1"></i>Belum ada autopost tercatat.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-lg-6 col-sm-6">
        <div class="card metric-card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="stat-label text-secondary fw-semibold">Kecepatan Respon</span>
                    <span class="icon-badge stat-icon text-warning">
                        <i class="bi bi-speedometer2"></i>
                    </span>
                </div>
                <div class="stat-primary">
                    {% if overview.avg_response_ms %}
                        {{ (overview.avg_response_ms / 1000)|round(2) }}s
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="stat-detail mt-2">
                    <i class="bi bi-lightning me-1"></i>
                    P90:
                    {% if overview.p90_response_ms %}
                        {{ (overview.p90_response_ms / 1000)|round(2) }}s
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="stat-detail mt-1">
                    {% if overview.last_reply %}
                        <i class="bi bi-clock me-1"></i>Balasan terakhir {{ overview.last_reply.created_at|jakarta('%d %b %Y %H:%M') }}
                    {% else %}
                        <i class="bi bi-clock me-1"></i>Belum ada balasan terekam
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-lg-6 col-sm-6">
        <div class="card metric-card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="stat-label text-secondary fw-semibold">Pengguna Unik</span>
                    <span class="icon-badge stat-icon text-info">
                        <i class="bi bi-people"></i>
                    </span>
                </div>
                <div class="stat-primary">{{ overview.total_users }}</div>
                <div class="stat-detail mt-2">
                    <i class="bi bi-person-plus me-1"></i>{{ overview.window_days }} hari: {{ overview.users_window }}
                </div>
                <div class="stat-detail mt-1">
                    {% if overview.last_mention %}
                        <i class="bi bi-person-circle me-1"></i>
                        Terakhir @{{ overview.last_mention.username or 'unknown' }} {{ overview.last_mention.created_at|jakarta('%d %b %Y %H:%M') }}
                    {% else %}
                        <i class="bi bi-dot me-1"></i>Belum ada mention.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="icon-badge section-icon text-primary">
                            <i class="bi bi-graph-up-arrow"></i>
                        </span>
                        <div>
                            <h2 class="h6 fw-bold mb-0">Aktivitas Mention vs Balasan</h2>
                            <p class="text-muted small mb-0">45 hari terakhir</p>
                        </div>
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>Tinggi batang = volume mention, garis = balasan.
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="twitterActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm runtime-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="icon-badge section-icon text-primary">
                        <i class="bi bi-hdd-network"></i>
                    </span>
                    <div>
                        <h2 class="h6 fw-bold mb-0">Runtime Worker</h2>
                        <p class="small text-muted mb-0">Autopost & state Twitter</p>
                    </div>
                </div>
                <ul class="small text-muted mb-3">
                    <li>
                        <span class="status-dot {% if runtime.settings.mentions_enabled %}bg-success{% else %}bg-danger{% endif %}"></span>
                        Mentions auto-reply
                        <strong class="ms-1 text-body">{{ 'Aktif' if runtime.settings.mentions_enabled else 'Mati' }}</strong>
                        <span class="ms-2">cooldown {{ runtime.settings.mentions_cooldown }}s • max {{ runtime.settings.mentions_max_results }} mention</span>
                    </li>
                    <li>
                        <span class="status-dot {% if runtime.settings.autopost_enabled %}bg-success{% else %}bg-secondary{% endif %}"></span>
                        Autopost
                        <strong class="ms-1 text-body">{{ 'Aktif' if runtime.settings.autopost_enabled else 'Mati' }}</strong>
                        <span class="ms-2">interval {{ runtime.settings.autopost_interval }}s • recent cache {{ runtime.settings.autopost_recent_limit }}</span>
                    </li>
                    <li>
                        <i class="bi bi-clock-history me-1"></i>Polling mention setiap {{ runtime.settings.poll_interval }} detik
                    </li>
                    <li>
                        <i class="bi bi-chat-dots me-1"></i>Last seen ID:
                        {% if runtime.last_seen_id %}
                            <a href="https://x.com/i/status/{{ runtime.last_seen_id }}" class="link-secondary" target="_blank" rel="noopener">
                                {{ runtime.last_seen_id }}
                            </a>
                        {% else %}
                            <span class="text-body">Belum tersedia</span>
                        {% endif %}
                    </li>
                    <li>
                        <i class="bi bi-send-check me-1"></i>Autopost terakhir:
                        {% if runtime.last_autopost_local %}
                            {{ runtime.last_autopost_local|jakarta('%d %b %Y %H:%M') }}
                        {% else %}
                            <span class="text-body">Belum pernah</span>
                        {% endif %}
                    </li>
                </ul>
                {% if runtime.autopost_error %}
                    <div class="alert alert-warning small" role="alert">
                        <i class="bi bi-exclamation-triangle me-1"></i>{{ runtime.autopost_error }}
                    </div>
                {% endif %}
                {% if runtime.state_error %}
                    <div class="alert alert-warning small" role="alert">
                        <i class="bi bi-exclamation-octagon me-1"></i>{{ runtime.state_error }}
                    </div>
                {% endif %}
                <div class="border rounded p-2 small">
                    <div class="d-flex justify-content-between">
                        <span class="fw-semibold text-body">Daftar Autopost</span>
                        <span class="badge text-bg-light border">Total {{ runtime.autopost_total }} • RAG {{ runtime.autopost_rag_total }}</span>
                    </div>
                    {% if runtime.autopost_preview %}
                        <ul class="autopost-preview mt-2 mb-0">
                            {% for item in runtime.autopost_preview %}
                            <li>
                                {% if item.is_rag %}
                                    <span class="badge text-bg-primary-subtle border border-primary-subtle me-1">RAG</span>
                                {% endif %}
                                {% if item.has_placeholders %}
                                    <span class="badge text-bg-warning-subtle border border-warning-subtle me-1">Token</span>
                                {% endif %}
                                <span class="text-body">{{ item.display }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0 mt-2">Belum ada template autopost siap pakai.</p>
                    {% endif %}
                    <div class="mt-2 d-flex justify-content-between text-muted">
                        <span><i class="bi bi-file-earmark-text me-1"></i>{{ runtime.autopost_path }}</span>
                        <span><i class="bi bi-arrow-repeat me-1"></i>Max {{ runtime.settings.max_tweet_len }} karakter</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="icon-badge section-icon text-primary">
                        <i class="bi bi-trophy"></i>
                    </span>
                    <div>
                        <h2 class="h6 fw-bold mb-0">Top Penyebut Bot</h2>
                        <p class="text-muted small mb-0">Mentions terbanyak sepanjang waktu</p>
                    </div>
                </div>
                <div class="table-responsive console-log-table-wrapper">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">User</th>
                                <th scope="col" class="text-end">Mention</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in top_users %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">@{{ user.username }}</div>
                                    <div class="small text-muted">ID {{ user.user_id }} • {{ user.last_seen|jakarta('%d %b %Y %H:%M') }}</div>
                                </td>
                                <td class="text-end fw-semibold">{{ user.mentions }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center py-3 text-muted">Belum ada data.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="icon-badge section-icon text-primary">
                        <i class="bi bi-list-check"></i>
                    </span>
                    <div>
                        <h2 class="h6 fw-bold mb-0">Riwayat Mention & Balasan</h2>
                        <p class="text-muted small mb-0">
                            Data percakapan dari chat_logs dengan topic <code>twitter</code>.
                            {% if page_autopost_total %}
                                <span class="badge text-bg-info-subtle border border-info-subtle ms-1">Autopost {{ page_autopost_total }}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 log-table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 110px;">Waktu</th>
                                <th scope="col" style="width: 90px;">Arah</th>
                                <th scope="col" style="width: 160px;">Akun</th>
                                <th scope="col">Konten</th>
                                <th scope="col" style="width: 120px;">Response (ms)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in records %}
                            <tr class="{% if row.is_autopost %}log-row-autopost{% endif %}">
                                <td><span class="badge text-bg-light border">{{ row.created_at|jakarta('%d %b %Y %H:%M') }}</span></td>
                                <td>
                                    {% if row.is_autopost %}
                                        <span class="badge text-bg-info log-badge"><i class="bi bi-megaphone me-1"></i>Autopost</span>
                                    {% elif row.role == 'aska' %}
                                        <span class="badge text-bg-primary log-badge"><i class="bi bi-arrow-return-right me-1"></i>Balasan</span>
                                    {% else %}
                                        <span class="badge text-bg-secondary log-badge"><i class="bi bi-arrow-return-left me-1"></i>Mention</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.is_autopost %}
                                        <div class="fw-semibold d-flex align-items-center gap-1">
                                            <span class="badge text-bg-primary-subtle border border-primary-subtle">ASKA</span>
                                            @{{ runtime.bot_username or row.username or 'aska' }}
                                        </div>
                                    {% else %}
                                        <div class="fw-semibold">@{{ row.username or 'Anon' }}</div>
                                    {% endif %}
                                    <div class="small text-muted">
                                        ID {{ row.user_id or '-' }}
                                        {% if row.is_autopost %}
                                            • Autopost
                                        {% elif row.is_reply %}
                                            • Balasan otomatis
                                        {% else %}
                                            • Mention masuk
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ row.text }}</td>
                                <td>{{ row.response_time_ms or '-' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">Belum ada data untuk filter saat ini.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <nav class="mt-3" aria-label="Pagination log Twitter">
                    <ul class="pagination justify-content-end">
                        <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.twitter_logs', page=page-1 if page > 1 else 1, start=request.args.get('start'), end=request.args.get('end'), role=request.args.get('role'), search=request.args.get('search'), user_id=request.args.get('user_id'), range=request.args.get('range')) }}">Previous</a>
                        </li>
                        <li class="page-item disabled"><span class="page-link">Halaman {{ page }} / {{ total_pages }}</span></li>
                        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.twitter_logs', page=page+1 if page < total_pages else total_pages, start=request.args.get('start'), end=request.args.get('end'), role=request.args.get('role'), search=request.args.get('search'), user_id=request.args.get('user_id'), range=request.args.get('range')) }}">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="icon-badge section-icon text-primary">
                        <i class="bi bi-terminal"></i>
                    </span>
                    <div>
                        <h2 class="h6 fw-bold mb-0">Console Log Worker</h2>
                        <p class="text-muted small mb-0">Tangkapan logger <code>aska.twitter</code> terbaru (maks 120 baris).</p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 140px;">Waktu</th>
                                <th scope="col" style="width: 90px;">Level</th>
                                <th scope="col">Pesan</th>
                                <th scope="col" style="width: 220px;">Metadata</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in worker_logs %}
                            {% set level = (log.level or 'INFO')|upper %}
                            <tr>
                                <td><span class="badge text-bg-light border">{{ log.created_at|jakarta('%d %b %Y %H:%M:%S') }}</span></td>
                                <td>
                                    {% if level in ['ERROR', 'CRITICAL'] %}
                                        <span class="badge text-bg-danger log-level-badge">{{ level }}</span>
                                    {% elif level == 'WARNING' %}
                                        <span class="badge text-bg-warning text-dark log-level-badge">{{ level }}</span>
                                    {% else %}
                                        <span class="badge text-bg-secondary log-level-badge">{{ level }}</span>
                                    {% endif %}
                                </td>
                                <td style="white-space: pre-line;">{{ log.message }}</td>
                                <td>
                                    <div class="log-context">
                                        {% if log.tweet_id %}
                                            <div><i class="bi bi-twitter-x me-1"></i><a href="https://x.com/i/status/{{ log.tweet_id }}" target="_blank" rel="noopener">Tweet {{ log.tweet_id }}</a></div>
                                        {% endif %}
                                        {% if log.twitter_user_id %}
                                            <div><i class="bi bi-person me-1"></i>User ID {{ log.twitter_user_id }}</div>
                                        {% endif %}
                                        {% if log.context %}
                                            {% if log.context.username %}
                                                <div><i class="bi bi-at me-1"></i>@{{ log.context.username }}</div>
                                            {% endif %}
                                            {% if log.context.logger %}
                                                <div><i class="bi bi-journal-code me-1"></i>{{ log.context.logger }}:{{ log.context.function }}()</div>
                                            {% endif %}
                                            {% if log.context.exception %}
                                                <details class="mt-1">
                                                    <summary class="small text-danger">Exception Trace</summary>
                                                    <pre class="mt-2 small bg-body-secondary p-2 border rounded">{{ log.context.exception }}</pre>
                                                </details>
                                            {% endif %}
                                        {% endif %}
                                        {% if not (log.tweet_id or log.twitter_user_id or log.context) %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">Belum ada log worker yang tersimpan.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        const ctx = document.getElementById('twitterActivityChart');
        if (!ctx) return;
        const labels = {{ activity_days|tojson }};
        const mentions = {{ activity_mentions|tojson }};
        const replies = {{ activity_replies|tojson }};

        const styles = getComputedStyle(document.documentElement);
        const accent = styles.getPropertyValue('--accent').trim() || '#0d6efd';
        const success = styles.getPropertyValue('--bs-success').trim() || '#198754';
        const borderSoft = styles.getPropertyValue('--border-soft').trim() || 'rgba(148,163,184,0.2)';
        const textMuted = styles.getPropertyValue('--text-muted').trim() || '#64748b';

        function hexToRgba(hex, alpha) {
            const value = hex.replace('#', '');
            if (value.length === 3) {
                const r = parseInt(value[0] + value[0], 16);
                const g = parseInt(value[1] + value[1], 16);
                const b = parseInt(value[2] + value[2], 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            const bigint = parseInt(value, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Mention',
                        data: mentions,
                        backgroundColor: hexToRgba(accent, 0.35),
                        borderColor: accent,
                        borderWidth: 1,
                        order: 2,
                    },
                    {
                        type: 'line',
                        label: 'Balasan',
                        data: replies,
                        borderColor: success,
                        backgroundColor: hexToRgba(success, 0.15),
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 3,
                        order: 1,
                    },
                ],
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: textMuted },
                    }
                },
                scales: {
                    x: {
                        grid: { color: borderSoft },
                        ticks: { color: textMuted, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: borderSoft },
                        ticks: { color: textMuted },
                    }
                }
            }
        });
    })();
</script>
{% endblock %}
