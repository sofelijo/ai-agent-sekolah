{% extends "attendance/base.html" %}
{% block title %}Statistik Absensi{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .metric-card {
        border-radius: 1rem;
    }
    .progress-thin {
        height: 0.4rem;
    }
    #trendControlBar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
        width: 100%;
    }
    #trendControlBar > * {
        width: 100%;
    }
    #trendControlBar .btn-group {
        width: 100%;
    }
    #trendControlBar .form-select {
        width: 100%;
    }
    @media (min-width: 992px) {
        #trendControlBar {
            grid-template-columns: repeat(auto-fit, minmax(180px, auto));
            align-items: center;
        }
        #trendControlBar > * {
            width: auto;
        }
        #trendControlBar .btn-group {
            width: auto;
        }
        #trendControlBar .form-select {
            width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set daily_rows = daily_rows or [] %}
{% set totals_today = totals_today or {"masuk": 0, "alpa": 0, "izin": 0, "sakit": 0} %}
{% set days_count = daily_rows|length %}
{% set safe_days = days_count if days_count else 1 %}
{% set masuk_7d = daily_rows|sum(attribute='masuk') %}
{% set alpa_7d = daily_rows|sum(attribute='alpa') %}
{% set izin_7d = daily_rows|sum(attribute='izin') %}
{% set sakit_7d = daily_rows|sum(attribute='sakit') %}
{% set absences_7d = alpa_7d + izin_7d + sakit_7d %}
{% set total_activity_7d = masuk_7d + absences_7d %}
{% set attendance_rate_7d = (masuk_7d / total_activity_7d * 100) if total_activity_7d else 0 %}
{% set avg_presence_per_day = masuk_7d / safe_days %}
{% set avg_status_map = {
    "masuk": avg_presence_per_day,
    "alpa": alpa_7d / safe_days,
    "izin": izin_7d / safe_days,
    "sakit": sakit_7d / safe_days
} %}
{% set today_total_entries = (totals_today.get('masuk', 0)) + (totals_today.get('alpa', 0)) + (totals_today.get('izin', 0)) + (totals_today.get('sakit', 0)) %}
{% set today_status_cards = [
    {"key": "masuk", "label": "Masuk", "wrapper": "bg-success-subtle text-success", "bar": "bg-success"},
    {"key": "alpa", "label": "Alpa", "wrapper": "bg-danger-subtle text-danger", "bar": "bg-danger"},
    {"key": "izin", "label": "Izin", "wrapper": "bg-warning-subtle text-warning", "bar": "bg-warning"},
    {"key": "sakit", "label": "Sakit", "wrapper": "bg-info-subtle text-info", "bar": "bg-info"}
 ] %}
{% set class_submission_status = class_submission_status or {"submitted": [], "pending": []} %}
{% set submitted_classes = class_submission_status.get('submitted', []) %}
{% set pending_classes = class_submission_status.get('pending', []) %}
{% set total_class_count = overview.total_classes or (submitted_classes|length + pending_classes|length) %}
{% set submission_rate = (submitted_classes|length / total_class_count * 100) if total_class_count else 0 %}
{% set chart_zero_totals = chart_zero_totals or [] %}
{% set monthly_chart_options = monthly_chart_options or [] %}
{% set monthly_chart_default_key = monthly_chart_default_key or (monthly_chart_options[0].value if monthly_chart_options) %}
{% set academic_year_options = academic_year_options or [] %}
{% set academic_year_default_key = academic_year_default_key or (academic_year_options[0].value if academic_year_options) %}
{% set class_attendance_map = class_attendance_map or {} %}
{% set best_present = namespace(count=0, label="Belum ada data") %}
{% set highest_absence = namespace(count=0, label="Belum ada data") %}
{% for row in daily_rows %}
    {% set present = row.masuk or 0 %}
    {% set absence = (row.alpa or 0) + (row.izin or 0) + (row.sakit or 0) %}
    {% set day_label = row.attendance_date|jakarta('%a, %d %b') if row.attendance_date else 'Tanpa tanggal' %}
    {% if present > best_present.count %}
        {% set best_present.count = present %}
        {% set best_present.label = day_label %}
    {% endif %}
    {% if absence > highest_absence.count %}
        {% set highest_absence.count = absence %}
        {% set highest_absence.label = day_label %}
    {% endif %}
{% endfor %}

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
    <div>
        <h1 class="h3 mb-1">Ringkasan Absensi</h1>
        <p class="text-muted mb-0">Pantau keaktifan siswa dan progres pencatatan absensi seluruh kelas.</p>
    </div>
    <div class="text-end">
        <span class="badge text-bg-primary-subtle text-primary px-3 py-2 d-inline-flex align-items-center gap-2">
            <i class="bi bi-clock-history"></i>
            Diperbarui {{ generated_at|jakarta('%d %b %Y %H:%M') }}
        </span>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card metric-card shadow-sm border-0">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold">Total Kelas</div>
                <div class="display-6 fw-bold">{{ overview.total_classes }}</div>
                <div class="text-muted small">Kelas terdaftar dalam sistem.</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card shadow-sm border-0">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold">Total Siswa</div>
                <div class="display-6 fw-bold">{{ overview.total_students }}</div>
                <div class="text-muted small">Siswa aktif yang siap diabsen.</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card shadow-sm border-0">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold mb-1">Total Staff</div>
                <div class="d-flex align-items-start justify-content-between gap-3">
                    <div>
                        <div class="display-6 fw-bold">{{ overview.total_staff }}</div>
                        <div class="text-muted small">Pada dashboard.</div>
                    </div>
                    {% set staff_breakdown = overview.staff_breakdown or [] %}
                    {% if staff_breakdown %}
                    <div class="text-end small text-muted">
                        {% for item in staff_breakdown %}
                        <div class="text-nowrap">
                            <span>{{ item.jabatan }}</span>
                            <span class="fw-semibold text-dark ms-1">{{ item.total }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card shadow-sm border-0">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold">Staff Dengan Kelas</div>
                <div class="display-6 fw-bold">{{ overview.total_assigned_staff }}</div>
                <div class="text-muted small">Staff yang telah memilih kelas.</div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3 gap-3">
            <div>
                <h2 class="h5 mb-1">Progress Pengisian Kelas Hari Ini</h2>
                <p class="text-muted small mb-0">Pemantauan absensi kelas untuk {{ today_label }}.</p>
            </div>
            <span class="badge text-bg-primary-subtle text-primary px-3 py-2">
                {{ submitted_classes|length }} / {{ total_class_count }} kelas sudah mengisi
            </span>
        </div>
        <div class="row g-3 align-items-stretch">
            <div class="col-lg-4">
                <div class="border rounded h-100 p-3">
                    <div class="text-muted small text-uppercase fw-semibold mb-1">Persentase Pengisian</div>
                    <div class="display-6 fw-bold">{{ submission_rate|round(0) }}%</div>
                    <p class="text-muted small mb-3">Kelas telah melaporkan absensi hari ini.</p>
                    <div class="progress progress-thin bg-light mb-2">
                        <div class="progress-bar bg-primary" style="width: {{ submission_rate }}%"></div>
                    </div>
                    <div class="small text-muted">Belum mengisi: {{ pending_classes|length }} kelas</div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="border rounded h-100 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 mb-0">Sudah Mengisi</h3>
                        <span class="badge text-bg-success-subtle text-success">{{ submitted_classes|length }}</span>
                    </div>
                    {% if submitted_classes %}
                    <div class="small" style="max-height: 200px; overflow-y: auto;">
                        <div class="d-flex flex-wrap gap-2">
                            {% for cls in submitted_classes %}
                            <span class="badge rounded-pill bg-success-subtle text-success class-submitted-badge"
                                data-class-id="{{ cls.id }}"
                                data-class-name="{{ cls.name }}"
                                role="button"
                                tabindex="0">
                                {{ cls.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-top small">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="fw-semibold" id="classSubmissionDetailTitle">Pilih kelas untuk melihat detail</div>
                            </div>
                        </div>
                        <div id="classSubmissionStats" class="d-flex flex-wrap gap-2">
                            <span class="text-muted">Belum ada kelas yang dipilih.</span>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted small mb-0">Belum ada kelas yang mengirim absensi.</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-4">
                <div class="border rounded h-100 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 mb-0">Belum Mengisi</h3>
                        <span class="badge text-bg-danger-subtle text-danger">{{ pending_classes|length }}</span>
                    </div>
                    {% if pending_classes %}
                    <div class="small" style="max-height: 220px; overflow-y: auto;">
                        <div class="d-flex flex-wrap gap-2">
                            {% for cls in pending_classes %}
                            <span class="badge rounded-pill bg-danger-subtle text-danger">{{ cls.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted small mb-0">Seluruh kelas telah melaporkan absensi.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                    <div class="d-flex flex-column flex-xl-row align-items-xl-center justify-content-between mb-3 gap-3">
                        <div class="flex-grow-1">
                            <h2 class="h5 mb-1">Tren Kehadiran</h2>
                            <p class="text-muted small mb-0">Pilih rentang harian, bulanan, atau rekapan tahun ajaran.</p>
                        </div>
                        <div id="trendControlBar">
                        <div class="btn-group btn-group-sm flex-shrink-0" role="group" aria-label="Rentang grafik" id="trendRangeGroup">
                            <input type="radio" class="btn-check" name="trendRange" id="trendRangeWeekly" value="weekly" checked>
                            <label class="btn btn-outline-secondary" for="trendRangeWeekly">7 Hari</label>
                            <input type="radio" class="btn-check" name="trendRange" id="trendRangeMonthly" value="monthly">
                            <label class="btn btn-outline-secondary" for="trendRangeMonthly">Bulanan</label>
                            <input type="radio" class="btn-check" name="trendRange" id="trendRangeAcademic" value="academic">
                            <label class="btn btn-outline-secondary" for="trendRangeAcademic">Tahun Ajaran</label>
                        </div>
                        <div id="trendMonthlySelector" class="d-none flex-shrink-0">
                            <select id="monthlyRangeSelect" class="form-select form-select-sm" aria-label="Pilih bulan" style="min-width: 160px;">
                                {% if monthly_chart_options %}
                                    {% for option in monthly_chart_options %}
                                    <option value="{{ option.value }}" {% if option.value == monthly_chart_default_key %}selected{% endif %}>{{ option.label }}</option>
                                    {% endfor %}
                                {% else %}
                                <option value="" selected>Belum ada data bulan</option>
                                {% endif %}
                            </select>
                        </div>
                        <div id="trendAcademicSelector" class="d-none flex-shrink-0">
                            <select id="academicYearSelect" class="form-select form-select-sm" aria-label="Pilih tahun ajaran" style="min-width: 140px;">
                                {% if academic_year_options %}
                                    {% for option in academic_year_options %}
                                    <option value="{{ option.value }}" {% if option.value == academic_year_default_key %}selected{% endif %}>{{ option.label }}</option>
                                    {% endfor %}
                                {% else %}
                                <option value="" selected>Tidak ada data tahun ajaran</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="d-flex flex-wrap gap-2 flex-shrink-0">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="toggleWeekendDays">
                                <label class="form-check-label small" for="toggleWeekendDays">Tanpa weekend</label>
                            </div>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="toggleMasukSeries">
                                <label class="form-check-label small" for="toggleMasukSeries">Tanpa data Masuk</label>
                            </div>
                        </div>
                    </div>
                </div>
                <canvas id="attendanceTrendChart" height="220"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="summaryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-today" data-bs-toggle="tab" data-bs-target="#tabToday" type="button" role="tab" aria-controls="tabToday" aria-selected="true">
                            Hari Ini
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-missing" data-bs-toggle="tab" data-bs-target="#tabMissing" type="button" role="tab" aria-controls="tabMissing" aria-selected="false">
                            Tidak Absen
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="summaryTabsContent">
                    <div class="tab-pane fade show active" id="tabToday" role="tabpanel" aria-labelledby="tab-today">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h2 class="h6 mb-1">Ringkasan Hari Ini</h2>
                                <p class="text-muted small mb-0">{{ today_label }}</p>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            {% for card in today_status_cards %}
                            {% set value = totals_today.get(card.key, 0) %}
                            {% set pct = (value / today_total_entries * 100) if today_total_entries else 0 %}
                            {% set delta = value - avg_status_map.get(card.key, 0) %}
                            <div class="p-3 border rounded {{ card.wrapper }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">{{ card.label }}</span>
                                    <span class="fs-4 fw-bold">{{ value }}</span>
                                </div>
                                <div class="progress progress-thin mt-3 mb-2">
                                    <div class="progress-bar {{ card.bar }}" style="width: {{ pct }}%"></div>
                                </div>
                                <div class="d-flex justify-content-between flex-wrap small">
                                    <span>{{ pct|round(1) }}% dari total</span>
                                    <span class="{% if delta >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if delta >= 0 %}+{% endif %}{{ delta|round(1) }} vs rata-rata 7 hari
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabMissing" role="tabpanel" aria-labelledby="tab-missing">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h2 class="h6 mb-1">Kelas Terbanyak Tidak Absen</h2>
                                <p class="text-muted small mb-0">
                                    Periode {{ missing_range_start|jakarta("%d %b %Y") }} - {{ missing_range_end|jakarta("%d %b %Y") }} · Tanpa weekend
                                </p>
                            </div>
                        </div>
                        {% if most_missing_classes %}
                        <div class="d-grid gap-2">
                            {% for row in most_missing_classes %}
                            {% set pct = (row.missing_days / row.total_days * 100) if row.total_days else 0 %}
                            <div class="p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">{{ row.name }}</span>
                                    <span class="fw-semibold text-danger">{{ row.missing_days }} hari</span>
                                </div>
                                <div class="progress progress-thin mt-3 mb-2">
                                    <div class="progress-bar bg-danger" style="width: {{ pct }}%"></div>
                                </div>
                                <div class="d-flex justify-content-between flex-wrap small text-muted">
                                    <span>{{ pct|round(1) }}% dari {{ row.total_days }} hari kerja</span>
                                    <span>Tidak ada absen</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small">Belum ada data ketidakhadiran kelas pada periode ini.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="h5 mb-1">Rincian 7 Hari</h2>
                        <p class="text-muted small mb-0">Status kehadiran per tanggal untuk satu minggu terakhir.</p>
                    </div>
                </div>
                {% if daily_rows %}
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Tanggal</th>
                                <th class="text-success">Masuk</th>
                                <th class="text-danger">Alpa</th>
                                <th class="text-warning">Izin</th>
                                <th class="text-info">Sakit</th>
                                <th>Total</th>
                                <th>Catatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in daily_rows %}
                            {% set total_per_day = (row.masuk or 0) + (row.alpa or 0) + (row.izin or 0) + (row.sakit or 0) %}
                            {% set absence_per_day = total_per_day - (row.masuk or 0) %}
                            {% set presence_pct = ((row.masuk or 0) / total_per_day * 100) if total_per_day else 0 %}
                            <tr>
                                <td class="fw-semibold">{{ row.attendance_date|jakarta('%a, %d %b') if row.attendance_date else '—' }}</td>
                                <td class="text-success fw-semibold">{{ row.masuk or 0 }}</td>
                                <td class="text-danger fw-semibold">{{ row.alpa or 0 }}</td>
                                <td class="text-warning fw-semibold">{{ row.izin or 0 }}</td>
                                <td class="text-info fw-semibold">{{ row.sakit or 0 }}</td>
                                <td class="fw-semibold">{{ total_per_day }}</td>
                                <td>
                                    {% if total_per_day %}
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="badge rounded-pill bg-success-subtle text-success">{{ presence_pct|round(0) }}% hadir</span>
                                        {% if absence_per_day %}
                                        <span class="badge rounded-pill bg-danger-subtle text-danger">{{ absence_per_day }} tidak hadir</span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="text-muted small">Belum ada entri</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted small mb-0">Belum ada data rekap 7 hari terakhir.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="h5 mb-1">Distribusi Status 7 Hari</h2>
                        <p class="text-muted small mb-0">Proporsi masing-masing status kehadiran.</p>
                    </div>
                </div>
                {% if total_activity_7d %}
                {% set distribution_statuses = [
                    {"label": "Masuk", "value": masuk_7d, "bar": "bg-success"},
                    {"label": "Alpa", "value": alpa_7d, "bar": "bg-danger"},
                    {"label": "Izin", "value": izin_7d, "bar": "bg-warning"},
                    {"label": "Sakit", "value": sakit_7d, "bar": "bg-info"}
                ] %}
                <div class="d-flex flex-column gap-3">
                    {% for item in distribution_statuses %}
                    {% set pct = (item.value / total_activity_7d * 100) if total_activity_7d else 0 %}
                    <div>
                        <div class="d-flex justify-content-between small">
                            <span>{{ item.label }}</span>
                            <span class="fw-semibold">{{ pct|round(1) }}%</span>
                        </div>
                        <div class="progress progress-thin bg-light">
                            <div class="progress-bar {{ item.bar }}" style="width: {{ pct }}%"></div>
                        </div>
                        <div class="text-muted small mt-1">{{ item.value }} entri dalam 7 hari.</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">Belum ada data absen untuk dihitung.</p>
                {% endif %}
                <hr class="my-4">
                <div class="mt-auto">
                    <h3 class="h6 mb-2">Catatan Otomatis</h3>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-1">
                            <i class="bi bi-graph-up-arrow text-success me-2"></i>
                            Rata-rata kehadiran {{ attendance_rate_7d|round(1) }}% dari total entri.
                        </li>
                        <li class="mb-1">
                            <i class="bi bi-exclamation-octagon text-danger me-2"></i>
                            {{ highest_absence.count }} ketidakhadiran terjadi pada {{ highest_absence.label }}.
                        </li>
                        <li>
                            <i class="bi bi-people text-primary me-2"></i>
                            {{ best_present.count }} siswa hadir pada hari terbaik ({{ best_present.label }}).
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="h5 mb-1">Aktivitas Absensi Terbaru</h2>
                <p class="text-muted small mb-0">Daftar verifikasi absensi yang paling baru disimpan.</p>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Kelas</th>
                        <th>Tanggal Terakhir</th>
                        <th>Diverifikasi Oleh</th>
                        <th>Jumlah Entri</th>
                        <th>Diperbarui</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in recent_records %}
                    <tr>
                        <td class="fw-semibold">{{ record.class_name }}</td>
                        <td>{{ record.last_date|jakarta('%d %b %Y') if record.last_date }}</td>
                        <td>{{ record.teacher_name or record.teacher_email or '—' }}</td>
                        <td>{{ record.total_records or 0 }}</td>
                        <td>{{ record.updated_at|jakarta('%d %b %Y %H:%M') if record.updated_at }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">Belum ada data absensi yang tercatat.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    var trendCanvas = document.getElementById("attendanceTrendChart");
    if (!trendCanvas) {
        return;
    }
    var trendWeekly = {{ trend_weekly_payload|tojson }};
    var trendMonthly = {{ trend_monthly_payload|tojson }};
    var trendAcademic = {{ trend_academic_payload|tojson }};
    var STATUS_CONFIG = [
        { key: "masuk", label: "Masuk", color: "#198754" },
        { key: "alpa", label: "Alpa", color: "#dc3545" },
        { key: "izin", label: "Izin", color: "#ffc107" },
        { key: "sakit", label: "Sakit", color: "#0dcaf0" }
    ];
    var datasets = STATUS_CONFIG.map(function (config) {
        var initialValues = (trendWeekly.series && trendWeekly.series[config.key]) || [];
        return {
            label: config.label,
            data: initialValues.slice(),
            fill: false,
            borderColor: config.color,
            backgroundColor: config.color,
            tension: 0.3,
            borderWidth: 2
        };
    });
    var chart = new Chart(trendCanvas, {
        type: "line",
        data: {
            labels: (trendWeekly.labels || []).slice(),
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    ticks: {
                        precision: 0
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: "bottom"
                }
            }
        }
    });
    var toggleMasukSwitch = document.getElementById("toggleMasukSeries");
    var toggleWeekendSwitch = document.getElementById("toggleWeekendDays");
    var monthlySelect = document.getElementById("monthlyRangeSelect");
    var academicSelect = document.getElementById("academicYearSelect");
    var monthlySelectorWrap = document.getElementById("trendMonthlySelector");
    var academicSelectorWrap = document.getElementById("trendAcademicSelector");
    var MASUK_DATASET_INDEX = 0;
    if (toggleMasukSwitch) {
        toggleMasukSwitch.addEventListener("change", function () {
            var meta = chart.getDatasetMeta(MASUK_DATASET_INDEX);
            if (!meta) {
                return;
            }
            meta.hidden = toggleMasukSwitch.checked ? true : null;
            chart.update();
        });
    }
    var trendState = {
        mode: "weekly",
        hideWeekend: false,
        selectedMonth: monthlySelect ? monthlySelect.value : (trendMonthly ? trendMonthly.default : null),
        selectedAcademic: academicSelect ? academicSelect.value : (trendAcademic ? trendAcademic.default : null)
    };
    function ensureSelections() {
        if (trendMonthly && trendMonthly.datasets) {
            if (!trendState.selectedMonth || !trendMonthly.datasets[trendState.selectedMonth]) {
                var fallback = trendMonthly.default;
                if (!fallback || !trendMonthly.datasets[fallback]) {
                    var monthKeys = Object.keys(trendMonthly.datasets);
                    fallback = monthKeys.length ? monthKeys[0] : null;
                }
                trendState.selectedMonth = fallback;
                if (monthlySelect && fallback) {
                    monthlySelect.value = fallback;
                }
            }
        }
        if (trendAcademic && trendAcademic.datasets) {
            if (!trendState.selectedAcademic || !trendAcademic.datasets[trendState.selectedAcademic]) {
                var yearFallback = trendAcademic.default;
                if (!yearFallback || !trendAcademic.datasets[yearFallback]) {
                    var yearKeys = Object.keys(trendAcademic.datasets);
                    yearFallback = yearKeys.length ? yearKeys[0] : null;
                }
                trendState.selectedAcademic = yearFallback;
                if (academicSelect && yearFallback) {
                    academicSelect.value = yearFallback;
                }
            }
        }
    }
    function getDatasetForMode() {
        ensureSelections();
        if (trendState.mode === "weekly") {
            return trendWeekly || { labels: [], series: {}, zero_mask: [] };
        }
        if (trendState.mode === "monthly") {
            if (trendMonthly && trendMonthly.datasets) {
                return trendMonthly.datasets[trendState.selectedMonth] || { labels: [], series: {}, zero_mask: [] };
            }
            return { labels: [], series: {}, zero_mask: [] };
        }
        if (trendAcademic && trendAcademic.datasets) {
            return trendAcademic.datasets[trendState.selectedAcademic] || { labels: [], series: {}, zero_mask: [] };
        }
        return { labels: [], series: {}, zero_mask: [] };
    }
    function renderTrendChart() {
        var dataset = getDatasetForMode();
        var labels = Array.isArray(dataset.labels) ? dataset.labels.slice() : [];
        var zeroMask = Array.isArray(dataset.zero_mask) ? dataset.zero_mask.slice() : [];
        var applyWeekend = trendState.hideWeekend && trendState.mode !== "academic";
        var maskMatches = zeroMask.length === labels.length;
        var indexes = [];
        if (labels.length) {
            labels.forEach(function (_, idx) {
                if (applyWeekend && maskMatches && zeroMask[idx]) {
                    return;
                }
                indexes.push(idx);
            });
        }
        if (!indexes.length && labels.length && (!applyWeekend || !maskMatches)) {
            indexes = labels.map(function (_, idx) {
                return idx;
            });
        }
        chart.data.labels = indexes.map(function (idx) {
            return labels[idx];
        });
        STATUS_CONFIG.forEach(function (config, datasetIndex) {
            var values = (dataset.series && dataset.series[config.key]) ? dataset.series[config.key] : [];
            var filtered = indexes.map(function (idx) {
                return values[idx] || 0;
            });
            chart.data.datasets[datasetIndex].data = filtered;
        });
        chart.update();
    }
    function updateRangeVisibility() {
        var showMonthly = trendState.mode === "monthly";
        if (monthlySelectorWrap) {
            monthlySelectorWrap.classList.toggle("d-none", !showMonthly);
        }
        var showAcademic = trendState.mode === "academic";
        if (academicSelectorWrap) {
            academicSelectorWrap.classList.toggle("d-none", !showAcademic);
        }
        if (toggleWeekendSwitch) {
            var disableWeekend = trendState.mode === "academic";
            toggleWeekendSwitch.disabled = disableWeekend;
            if (disableWeekend && toggleWeekendSwitch.checked) {
                toggleWeekendSwitch.checked = false;
                trendState.hideWeekend = false;
            }
        }
    }
    var rangeRadios = document.querySelectorAll("input[name='trendRange']");
    rangeRadios.forEach(function (radio) {
        radio.addEventListener("change", function () {
            if (!this.checked) {
                return;
            }
            trendState.mode = this.value;
            updateRangeVisibility();
            renderTrendChart();
        });
    });
    if (monthlySelect) {
        monthlySelect.addEventListener("change", function () {
            trendState.selectedMonth = this.value;
            renderTrendChart();
        });
    }
    if (academicSelect) {
        academicSelect.addEventListener("change", function () {
            trendState.selectedAcademic = this.value;
            renderTrendChart();
        });
    }
    if (toggleWeekendSwitch) {
        toggleWeekendSwitch.addEventListener("change", function () {
            trendState.hideWeekend = toggleWeekendSwitch.checked;
            renderTrendChart();
        });
    }
    updateRangeVisibility();
    renderTrendChart();

    var classAttendanceMap = {{ class_attendance_map|tojson }};
    var classBadges = document.querySelectorAll(".class-submitted-badge");
    var classDetailTitle = document.getElementById("classSubmissionDetailTitle");
    var classDetailMeta = document.getElementById("classSubmissionMeta");
    var classDetailStats = document.getElementById("classSubmissionStats");
    function renderClassDetail(classId, fallbackName) {
        if (!classDetailTitle || !classDetailStats) {
            return;
        }
        var detail = classAttendanceMap[classId];
        if (!detail) {
            classDetailTitle.textContent = fallbackName || "Detail kelas tidak ditemukan";
            if (classDetailMeta) {
                classDetailMeta.textContent = "Data absensi tidak tersedia untuk kelas ini.";
            }
            classDetailStats.innerHTML = '<span class="text-muted">Tidak ada data yang bisa ditampilkan.</span>';
            return;
        }
        var displayName = fallbackName || detail.name || "Detail Kelas";
        classDetailTitle.textContent = displayName;
        if (classDetailMeta) {
            var metaParts = [];
            if (detail.total_students) {
                metaParts.push(detail.total_students + " siswa terdaftar");
            }
            if (detail.academic_year) {
                metaParts.push("TA " + detail.academic_year);
            }
            classDetailMeta.textContent = metaParts.join(" • ") || "—";
        }
        var statusOrder = ["masuk", "sakit", "izin", "alpa"];
        var statusLabels = {
            masuk: "Masuk",
            sakit: "Sakit",
            izin: "Izin",
            alpa: "Alpa"
        };
        var badgeClasses = {
            masuk: "bg-success-subtle text-success",
            sakit: "bg-info-subtle text-info",
            izin: "bg-warning-subtle text-warning",
            alpa: "bg-danger-subtle text-danger"
        };
        var htmlParts = statusOrder.map(function (key) {
            var value = detail[key] || 0;
            var label = statusLabels[key] || key;
            var badge = badgeClasses[key] || "bg-light text-muted";
            return '<span class="badge rounded-pill ' + badge + '">' + label + ': <strong>' + value + "</strong></span>";
        });
        classDetailStats.innerHTML = htmlParts.join(" ");
    }
    classBadges.forEach(function (badge) {
        badge.addEventListener("click", function () {
            var classId = this.getAttribute("data-class-id");
            var className = this.getAttribute("data-class-name");
            if (!classId) {
                return;
            }
            renderClassDetail(classId, className);
        });
        badge.addEventListener("keydown", function (event) {
            if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                this.click();
            }
        });
    });
});
</script>
{% endblock %}
