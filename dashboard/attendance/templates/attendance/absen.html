{% extends "attendance/base.html" %}
{% block title %}Absensi Siswa{% endblock %}

{% block content %}
{% set default_class_label = teacher_class.class_name if teacher_class and teacher_class.class_name else '' %}
{% set late_entries_list = late_entries or [] %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2 mb-4">
    <div>
        <h1 class="h3 mb-1">Absensi Siswa</h1>
        <p class="text-muted mb-0">Catat kehadiran siswa secara cepat dan konsisten setiap hari.</p>
    </div>
    <div class="text-lg-end">
        <span class="badge text-bg-primary-subtle text-primary d-inline-flex align-items-center gap-2 px-3 py-2">
            <i class="bi bi-calendar-event"></i>
            {{ selected_date_label }}
        </span>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <h2 class="h5 mb-1">Kelas Binaan</h2>
                        <p class="text-muted small mb-0">Pilih kelas yang Anda ampu sebagai wali kelas.</p>
                    </div>
                    <span class="badge text-bg-secondary">Staff</span>
                </div>

                {% if class_options %}
                <form method="post" action="{{ url_for('attendance.pilih_kelas') }}" id="classSelectionForm" class="d-grid gap-3">
                    <div>
                        <label for="classSelect" class="form-label fw-semibold">Kelas</label>
                        <select class="form-select" id="classSelect" name="class_id" data-current="{{ selected_class_id or '' }}" required>
                            <option value="">-- Pilih kelas --</option>
                            {% for class_item in class_options %}
                            <option value="{{ class_item.id }}" {% if class_item.id == selected_class_id %}selected{% endif %}>
                                {{ class_item.name }}{% if class_item.academic_year %} â€¢ {{ class_item.academic_year }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-circle me-1"></i> Simpan Kelas Utama
                    </button>
                </form>
                {% else %}
                <div class="alert alert-warning mb-0">
                    <div class="d-flex gap-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div>
                            <strong>Data kelas belum tersedia.</strong>
                            <div class="small">Hubungi administrator untuk menambahkan daftar kelas terlebih dahulu.</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if teacher_class and teacher_class.class_name %}
                <div class="border rounded p-3 mt-4 bg-body-tertiary">
                    <div class="d-flex align-items-start gap-2">
                        <span class="text-primary"><i class="bi bi-person-square fs-4"></i></span>
                        <div>
                            <div class="fw-semibold text-uppercase small text-muted">Kelas Saat Ini</div>
                            <div class="fs-5 fw-semibold">{{ teacher_class.class_name }}</div>
                            {% if teacher_class.academic_year %}
                            <div class="text-muted small">Tahun ajaran {{ teacher_class.academic_year }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column gap-4">
                <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                    <div>
                        <h2 class="h5 mb-2">Tanggal Absensi</h2>
                        <form class="d-flex align-items-center gap-2" method="get" action="{{ url_for('attendance.kelas') }}">
                            <input type="date" class="form-control" name="date" value="{{ selected_date.isoformat() }}" max="{{ today.date().isoformat() }}">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-repeat me-1"></i> Tampilkan
                            </button>
                        </form>
                        <div class="text-muted small mt-2">
                            {% if latest_submission_at %}
                            Terakhir diverifikasi: <strong>{{ latest_submission_at|jakarta("%d %b %Y %H:%M") }}</strong>
                            {% else %}
                            Belum ada data absensi yang tersimpan untuk tanggal ini.
                            {% endif %}
                        </div>
                    </div>
                    <div class="border rounded px-3 py-2 bg-body-tertiary">
                        <div class="small text-uppercase text-muted fw-semibold mb-2">Ringkasan Hari Ini</div>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge text-bg-success-subtle text-success">Masuk: {{ status_counts.masuk }}</span>
                            <span class="badge text-bg-danger-subtle text-danger">Alpa: {{ status_counts.alpa }}</span>
                            <span class="badge text-bg-warning-subtle text-warning">Izin: {{ status_counts.izin }}</span>
                            <span class="badge text-bg-info-subtle text-info">Sakit: {{ status_counts.sakit }}</span>
                        </div>
                        <div class="small text-muted mt-2">Total siswa: {{ total_students }}</div>
                        <a class="btn btn-outline-secondary btn-sm mt-3" href="{{ url_for('attendance.laporan_harian', date=selected_date.isoformat()) }}" target="_blank" rel="noopener">
                            <i class="bi bi-printer me-1"></i> Laporan Piket
                        </a>
                    </div>
                </div>
                <div class="text-muted small">
                    Pastikan Anda mengecek ulang sebelum menyimpan. Data absensi dapat diperbarui kembali pada tanggal yang sama jika diperlukan.
                </div>
            </div>
        </div>
    </div>
</div>

{% if selected_class_id %}
    {% if students %}
    <form method="post" action="{{ url_for('attendance.simpan_absen') }}" class="card shadow-sm">
        <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
            <div>
                <h2 class="h5 mb-0">Daftar Kehadiran</h2>
                <div class="text-muted small">Status default setiap siswa adalah <strong>masuk</strong>.</div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i> Simpan Absensi
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <input type="hidden" name="attendance_date" value="{{ selected_date.isoformat() }}">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">No</th>
                            <th>Nama Siswa</th>
                            <th style="width: 180px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td class="text-muted">{{ loop.index }}</td>
                            <td>
                                <div class="fw-semibold">{{ student.name }}</div>
                                {% if student.student_number %}
                                <div class="small text-muted">NIS: {{ student.student_number }}</div>
                                {% endif %}
                            </td>
                            <td>
                                <select class="form-select" name="status_{{ student.id }}">
                                    {% for status in attendance_statuses %}
                                    <option value="{{ status }}" {% if status == student.status %}selected{% endif %}>
                                        {{ status_labels[status] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-body border-top">
            <div class="d-flex flex-column flex-md-row align-items-md-start justify-content-between gap-3 mb-2">
                <div>
                    <h2 class="h5 mb-1">Catatan Siswa Terlambat</h2>
                    <p class="text-muted small mb-0">Isikan siswa yang datang terlambat agar tampil di laporan piket harian.</p>
                </div>
                <button type="button" id="addLateEntryButton" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-plus-lg me-1"></i> Tambah baris
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm late-entries-table mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Waktu</th>
                            <th>Alasan</th>
                            <th class="text-end" style="width: 1%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="lateEntriesBody">
                        {% for entry in late_entries_list %}
                        <tr>
                            <td>
                                <input type="text" name="late_name[]" class="form-control form-control-sm" list="studentNamesList" value="{{ entry.student_name or '' }}" placeholder="Nama siswa">
                            </td>
                            <td>
                                <input type="text" name="late_class[]" class="form-control form-control-sm" value="{{ entry.class_label or default_class_label }}" placeholder="Kelas">
                            </td>
                            <td>
                                <input type="time" name="late_time[]" class="form-control form-control-sm" value="{{ entry.arrival_time or '' }}">
                            </td>
                            <td>
                                <input type="text" name="late_reason[]" class="form-control form-control-sm" value="{{ entry.reason or '' }}" placeholder="Alasan (opsional)">
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-late-row">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not late_entries_list %}
                        <tr>
                            <td>
                                <input type="text" name="late_name[]" class="form-control form-control-sm" list="studentNamesList" placeholder="Nama siswa">
                            </td>
                            <td>
                                <input type="text" name="late_class[]" class="form-control form-control-sm" value="{{ default_class_label }}" placeholder="Kelas">
                            </td>
                            <td>
                                <input type="time" name="late_time[]" class="form-control form-control-sm">
                            </td>
                            <td>
                                <input type="text" name="late_reason[]" class="form-control form-control-sm" placeholder="Alasan (opsional)">
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-late-row">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <p class="text-muted small mt-2 mb-0">
                Kosongkan nama agar baris tidak disimpan. Waktu ditulis dalam format HH:MM.
            </p>
            <datalist id="studentNamesList">
                {% for student in students %}
                <option value="{{ student.name }}"></option>
                {% endfor %}
            </datalist>
            <template id="lateEntryRowTemplate">
                <tr>
                    <td>
                        <input type="text" name="late_name[]" class="form-control form-control-sm" list="studentNamesList" placeholder="Nama siswa">
                    </td>
                    <td>
                        <input type="text" name="late_class[]" class="form-control form-control-sm" value="{{ default_class_label }}" placeholder="Kelas">
                    </td>
                    <td>
                        <input type="time" name="late_time[]" class="form-control form-control-sm">
                    </td>
                    <td>
                        <input type="text" name="late_reason[]" class="form-control form-control-sm" placeholder="Alasan (opsional)">
                    </td>
                    <td class="text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-late-row">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                    </td>
                </tr>
            </template>
        </div>
        <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-clipboard-check me-1"></i> Simpan Absensi
            </button>
        </div>
    </form>
    {% else %}
    <div class="card shadow-sm border-0 text-center py-5">
        <div class="card-body">
            <i class="bi bi-people fs-1 text-muted mb-3"></i>
            <h2 class="h5">Belum ada data siswa</h2>
            <p class="text-muted small mb-0">Tambahkan data siswa untuk kelas ini agar dapat melakukan absensi.</p>
        </div>
    </div>
    {% endif %}
{% else %}
<div class="card shadow-sm border-0 text-center py-5">
    <div class="card-body">
        <i class="bi bi-journal-check fs-1 text-muted mb-3"></i>
        <h2 class="h5">Silakan pilih kelas terlebih dahulu</h2>
        <p class="text-muted small mb-0">Absensi hanya dapat dilakukan setelah kelas utama dipilih.</p>
    </div>
</div>
{% endif %}

{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .text-bg-primary-subtle {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    var form = document.getElementById("classSelectionForm");
    if (!form) {
        return;
    }
    form.addEventListener("submit", function (event) {
        var select = document.getElementById("classSelect");
        if (!select) {
            return;
        }
        var current = select.getAttribute("data-current");
        var chosen = select.value;
        if (current && current === chosen) {
            return;
        }
        var selectedOption = select.options[select.selectedIndex];
        var label = selectedOption ? selectedOption.text : "kelas yang dipilih";
        var confirmed = window.confirm("Anda akan mengatur kelas wali ke " + label + ". Lanjutkan?");
        if (!confirmed) {
            event.preventDefault();
        }
    });
    var lateEntriesBody = document.getElementById("lateEntriesBody");
    var lateEntryTemplate = document.getElementById("lateEntryRowTemplate");
    var addLateEntryButton = document.getElementById("addLateEntryButton");
    var defaultClassLabel = {{ default_class_label|default("", true)|tojson }};
    if (lateEntriesBody && lateEntryTemplate && addLateEntryButton) {
        addLateEntryButton.addEventListener("click", function () {
            lateEntriesBody.appendChild(lateEntryTemplate.content.cloneNode(true));
        });
        lateEntriesBody.addEventListener("click", function (event) {
            var trigger = event.target.closest(".remove-late-row");
            if (!trigger) {
                return;
            }
            var row = trigger.closest("tr");
            if (!row) {
                return;
            }
            var rows = lateEntriesBody.querySelectorAll("tr");
            if (rows.length <= 1) {
                var inputs = row.querySelectorAll("input");
                Array.prototype.forEach.call(inputs, function (input) {
                    if (input.name === "late_class[]") {
                        input.value = defaultClassLabel;
                    } else {
                        input.value = "";
                    }
                });
                return;
            }
            row.remove();
        });
    }
});
</script>
{% endblock %}
