{% extends "attendance/base.html" %}
{% block title %}Data Master Absensi{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .drag-handle {
        cursor: grab;
        display: inline-flex;
        align-items: center;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .student-order-row.dragging {
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
    <div>
        <h1 class="h3 mb-1">Pengelolaan Data Master</h1>
        <p class="text-muted mb-0">Tambah atau perbarui data kelas dan siswa untuk mendukung proses absensi.</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <span class="icon-badge text-primary bg-primary-subtle"><i class="bi bi-building"></i></span>
                    <h2 class="h5 mb-0">Tambah Kelas</h2>
                </div>
                <form method="post" class="d-grid gap-3">
                    <input type="hidden" name="action" value="create_class">
                    <div>
                        <label class="form-label">Nama Kelas</label>
                        <input type="text" class="form-control" name="class_name" placeholder="Contoh: 1C" required>
                    </div>
                    <div>
                        <label class="form-label">Tahun Ajaran</label>
                        <input type="text" class="form-control" name="academic_year" placeholder="2024/2025">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Simpan Kelas
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex flex-column gap-2 mb-3">
                    <div class="d-flex align-items-center justify-content-between gap-3">
                        <div class="d-flex align-items-center gap-3">
                            <span class="icon-badge text-success bg-success-subtle"><i class="bi bi-person-plus"></i></span>
                            <div>
                                <h2 class="h5 mb-0">Tambah / Perbarui Siswa</h2>
                                <p class="text-muted small mb-0">Klik baris siswa pada daftar di bawah untuk mengisi formulir ini; kartu akan berubah menjadi mode edit/hapus.</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-primary-subtle text-primary" id="studentFormMode">Mode Tambah</span>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="studentFormReset" hidden>Reset Form</button>
                        </div>
                    </div>
                </div>
                <form id="studentForm" method="post" class="d-grid gap-3">
                    <input type="hidden" name="action" id="studentFormAction" value="create_student">
                    <input type="hidden" name="student_id" id="studentIdInput">
                    <div>
                        <label class="form-label">Kelas</label>
                        <select class="form-select" name="student_class_id" required>
                            <option value="">-- Pilih kelas --</option>
                            {% for class_item in classes %}
                            <option value="{{ class_item.id }}">{{ class_item.name }}{% if class_item.academic_year %} • {{ class_item.academic_year }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" name="student_name" placeholder="Nama lengkap siswa" required>
                    </div>
                    <div>
                        <label class="form-label">NIS (Nomor Induk)</label>
                        <input type="text" class="form-control" name="student_number" placeholder="Nomor induk siswa">
                    </div>
                    <div>
                        <label class="form-label">NISN</label>
                        <input type="text" class="form-control" name="student_nisn" placeholder="Nomor Induk Siswa Nasional">
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Jenis Kelamin</label>
                            <select class="form-select" name="student_gender">
                                <option value="">-- Pilih --</option>
                                <option value="L">Laki-laki (L)</option>
                                <option value="P">Perempuan (P)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Agama</label>
                            <input type="text" class="form-control" name="student_religion" placeholder="Contoh: Islam">
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Tempat Lahir</label>
                            <input type="text" class="form-control" name="student_birth_place" placeholder="Kota lahir">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tanggal Lahir</label>
                            <input type="date" class="form-control" name="student_birth_date">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Alamat Jalan</label>
                        <input type="text" class="form-control" name="student_address" placeholder="Nama jalan / perumahan">
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">RT</label>
                            <input type="text" class="form-control" name="student_rt" placeholder="RT">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">RW</label>
                            <input type="text" class="form-control" name="student_rw" placeholder="RW">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kelurahan</label>
                            <input type="text" class="form-control" name="student_kelurahan" placeholder="Kelurahan">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Kecamatan</label>
                        <input type="text" class="form-control" name="student_kecamatan" placeholder="Kecamatan">
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Nama Ayah</label>
                            <input type="text" class="form-control" name="student_father" placeholder="Nama ayah">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nama Ibu</label>
                            <input type="text" class="form-control" name="student_mother" placeholder="Nama ibu">
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">NIK</label>
                            <input type="text" class="form-control" name="student_nik" placeholder="NIK keluarga">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">No. KK</label>
                            <input type="text" class="form-control" name="student_kk" placeholder="Nomor Kartu Keluarga">
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="submit" class="btn btn-success" id="studentFormSubmit" data-default-label="Simpan Siswa" data-update-label="Perbarui Siswa">
                            <i class="bi bi-check2-circle me-2"></i><span class="student-form-submit-label">Simpan Siswa</span>
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="studentFormDelete" data-action="delete_student" hidden formnovalidate>
                            <i class="bi bi-trash me-2"></i>Hapus Siswa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <span class="icon-badge text-info bg-info-subtle"><i class="bi bi-info-circle"></i></span>
                    <h2 class="h5 mb-0">Tips Pengelolaan</h2>
                </div>
                <ul class="list-unstyled small text-muted d-grid gap-2 mb-0">
                    <li><i class="bi bi-dot"></i> Pastikan nama kelas unik agar staff dapat memilih kelas binaan dengan mudah.</li>
                    <li><i class="bi bi-dot"></i> Bila nama siswa sama, gunakan kolom NIS untuk membedakan.</li>
                    <li><i class="bi bi-dot"></i> Data siswa dapat diperbarui dengan mengisi ulang form dengan nama yang sama.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mt-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h2 class="h5 mb-1">Daftar Kelas &amp; Siswa</h2>
                <p class="text-muted small mb-0">Daftar ini menampilkan struktur kelas beserta siswa terdaftar.</p>
                <p class="text-muted small mb-0">Klik baris siswa untuk menyalin data ke formulir di atas.</p>
                {% if current_user and current_user.role == 'admin' %}
                <p class="text-muted small mb-0">Admin dapat mengubah urutan nomor absen dengan drag di kolom No.</p>
                {% endif %}
            </div>
        </div>
        <div class="accordion" id="classAccordion"
            data-can-reorder="{{ 'true' if current_user and current_user.role == 'admin' else 'false' }}"
            data-reorder-url="{{ url_for('attendance.update_student_order') }}">
            {% for class_item in classes %}
            {% set class_id = class_item.id|int %}
            {% set students = students_by_class.get(class_id, []) %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ class_id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ class_id }}" aria-expanded="false" aria-controls="collapse-{{ class_id }}">
                        <div class="d-flex flex-column">
                            <span class="fw-semibold">{{ class_item.name }}</span>
                            <span class="text-muted small">{{ students|length }} siswa terdaftar{% if class_item.academic_year %} • {{ class_item.academic_year }}{% endif %}</span>
                        </div>
                    </button>
                </h2>
                <div id="collapse-{{ class_id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ class_id }}" data-bs-parent="#classAccordion">
                    <div class="accordion-body">
                        {% if students %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            No
                                            {% if current_user and current_user.role == 'admin' %}
                                            <i class="bi bi-grip-vertical text-muted ms-1"></i>
                                            {% endif %}
                                        </th>
                                        <th>Nama Siswa</th>
                                        <th>NIS / NISN</th>
                                        <th>JK</th>
                                        <th>TTL</th>
                                        <th>Alamat</th>
                                        <th>Orang Tua</th>
                                        <th>NIK / KK</th>
                                    </tr>
                                </thead>
                                <tbody data-class-id="{{ class_id }}">
                                    {% for student in students %}
                                    {% set student_payload = {
                                        "id": student.id,
                                        "student_class_id": class_id,
                                        "student_name": student.full_name,
                                        "student_number": student.student_number or '',
                                        "student_nisn": student.nisn or '',
                                        "student_gender": student.gender or '',
                                        "student_birth_place": student.birth_place or '',
                                        "student_birth_date": student.birth_date.isoformat() if student.birth_date else '',
                                        "student_religion": student.religion or '',
                                        "student_address": student.address_line or '',
                                        "student_rt": student.rt or '',
                                        "student_rw": student.rw or '',
                                        "student_kelurahan": student.kelurahan or '',
                                        "student_kecamatan": student.kecamatan or '',
                                        "student_father": student.father_name or '',
                                        "student_mother": student.mother_name or '',
                                        "student_nik": student.nik or '',
                                        "student_kk": student.kk_number or ''
                                    } %}
                                    <tr class="student-row{% if current_user and current_user.role == 'admin' %} student-order-row{% endif %}"
                                        role="button" data-student='{{ student_payload | tojson | safe }}'
                                        data-student-id="{{ student.id }}"
                                        {% if current_user and current_user.role == 'admin' %}draggable="true"{% endif %}
                                        style="cursor: pointer;">
                                        <td>
                                            {% if current_user and current_user.role == 'admin' %}
                                            <span class="drag-handle text-muted me-2" title="Drag untuk ubah urutan">
                                                <i class="bi bi-grip-vertical"></i>
                                            </span>
                                            {% endif %}
                                            <span class="sequence-number">{{ student.sequence or loop.index }}</span>
                                        </td>
                                        <td>{{ student.full_name }}</td>
                                        <td>
                                            <div>{{ student.student_number or '—' }}</div>
                                            <div class="text-muted small">{{ student.nisn|default('-', true) }}</div>
                                        </td>
                                        <td>{{ student.gender or '—' }}</td>
                                        <td>
                                            <div>{{ student.birth_place or '—' }}</div>
                                            <div class="text-muted small">{{ student.birth_date|default('-', true) }}</div>
                                        </td>
                                        <td>
                                            <div>{{ student.address_line or '—' }}</div>
                                            <div class="text-muted small">RT {{ student.rt or '-' }} / RW {{ student.rw or '-' }}</div>
                                            <div class="text-muted small">{{ student.kelurahan or '-' }} • {{ student.kecamatan or '-' }}</div>
                                        </td>
                                        <td>
                                            <div>{{ student.father_name or '—' }}</div>
                                            <div class="text-muted small">{{ student.mother_name|default('-', true) }}</div>
                                        </td>
                                        <td>
                                            <div>{{ student.nik or '—' }}</div>
                                            <div class="text-muted small">{{ student.kk_number|default('-', true) }}</div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-card-list fs-4 d-block mb-2"></i>
                            Belum ada siswa pada kelas ini.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-collection fs-1 d-block mb-3"></i>
                Belum ada data kelas. Tambahkan kelas terlebih dahulu.
            </div>
            {% endfor %}
        </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    var studentRows = document.querySelectorAll(".student-row[data-student]");
    var studentForm = document.getElementById("studentForm");
    if (!studentForm) {
        return;
    }
    var dragInProgress = false;
    var actionInput = document.getElementById("studentFormAction");
    var studentIdInput = document.getElementById("studentIdInput");
    var modeBadge = document.getElementById("studentFormMode");
    var resetButton = document.getElementById("studentFormReset");
    var submitButton = document.getElementById("studentFormSubmit");
    var submitLabel = submitButton ? submitButton.querySelector(".student-form-submit-label") : null;
    var defaultLabel = submitButton ? (submitButton.getAttribute("data-default-label") || "Simpan Siswa") : "Simpan Siswa";
    var updateLabel = submitButton ? (submitButton.getAttribute("data-update-label") || "Perbarui Siswa") : "Perbarui Siswa";
    var deleteButton = document.getElementById("studentFormDelete");

    function setMode(isEdit) {
        if (modeBadge) {
            if (isEdit) {
                modeBadge.classList.remove("bg-primary-subtle", "text-primary");
                modeBadge.classList.add("bg-warning-subtle", "text-warning");
                modeBadge.textContent = "Mode Edit";
            } else {
                modeBadge.classList.remove("bg-warning-subtle", "text-warning");
                modeBadge.classList.add("bg-primary-subtle", "text-primary");
                modeBadge.textContent = "Mode Tambah";
            }
        }
        if (submitLabel) {
            submitLabel.textContent = isEdit ? updateLabel : defaultLabel;
        }
        if (resetButton) {
            resetButton.hidden = !isEdit;
        }
        if (deleteButton) {
            deleteButton.hidden = !isEdit;
        }
    }

    function fillForm(payload) {
        Object.keys(payload).forEach(function (key) {
            if (!key.startsWith("student_")) {
                return;
            }
            var input = studentForm.querySelector('[name="' + key + '"]');
            if (!input) {
                return;
            }
            var value = payload[key];
            if (value === null || value === undefined) {
                value = "";
            }
            if (input.tagName === "SELECT") {
                input.value = value;
            } else {
                input.value = value;
            }
        });
    }

    function handleRowClick(event) {
        if (dragInProgress) {
            return;
        }
        if (event.target && event.target.closest(".drag-handle")) {
            return;
        }
        var row = event.currentTarget;
        var raw = row.getAttribute("data-student");
        if (!raw) {
            return;
        }
        var payload;
        try {
            payload = JSON.parse(raw);
        } catch (error) {
            return;
        }
        if (!payload.id) {
            return;
        }
        if (actionInput) {
            actionInput.value = "update_student";
        }
        if (studentIdInput) {
            studentIdInput.value = payload.id;
        }
        fillForm(payload);
        setMode(true);
        studentForm.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    studentRows.forEach(function (row) {
        row.addEventListener("click", handleRowClick);
    });

    if (deleteButton) {
        deleteButton.addEventListener("click", function (event) {
            event.preventDefault();
            if (!studentIdInput || !studentIdInput.value) {
                return;
            }
            var confirmed = window.confirm("Yakin ingin menghapus siswa ini? Aksi tidak dapat dibatalkan.");
            if (!confirmed) {
                return;
            }
            var targetAction = deleteButton.dataset.action || "delete_student";
            if (actionInput) {
                actionInput.value = targetAction;
            }
            studentForm.submit();
        });
    }

    if (resetButton) {
        resetButton.addEventListener("click", function () {
            studentForm.reset();
            if (actionInput) {
                actionInput.value = "create_student";
            }
            if (studentIdInput) {
                studentIdInput.value = "";
            }
            setMode(false);
        });
    }

    setMode(false);

    var accordion = document.getElementById("classAccordion");
    var canReorder = accordion && accordion.dataset.canReorder === "true";
    if (!canReorder) {
        return;
    }
    var reorderUrl = accordion.dataset.reorderUrl;
    if (!reorderUrl) {
        return;
    }

    function parseStudentId(value) {
        var parsed = parseInt(value, 10);
        return isNaN(parsed) ? null : parsed;
    }

    function getOrder(tbody) {
        var ids = [];
        var rows = tbody.querySelectorAll("tr[data-student-id]");
        rows.forEach(function (row) {
            var studentId = parseStudentId(row.dataset.studentId);
            if (studentId !== null) {
                ids.push(studentId);
            }
        });
        return ids;
    }

    function updateSequenceLabels(tbody) {
        var rows = tbody.querySelectorAll("tr[data-student-id]");
        rows.forEach(function (row, index) {
            var seqEl = row.querySelector(".sequence-number");
            if (seqEl) {
                seqEl.textContent = String(index + 1);
            }
        });
    }

    function applyOrder(tbody, orderedIds) {
        var rowMap = {};
        tbody.querySelectorAll("tr[data-student-id]").forEach(function (row) {
            rowMap[row.dataset.studentId] = row;
        });
        orderedIds.forEach(function (studentId) {
            var row = rowMap[String(studentId)];
            if (row) {
                tbody.appendChild(row);
            }
        });
    }

    function persistOrder(tbody) {
        var previousOrder = (tbody.dataset.order || "")
            .split(",")
            .map(function (value) {
                return parseStudentId(value);
            })
            .filter(function (value) {
                return value !== null;
            });
        var nextOrder = getOrder(tbody);
        if (!nextOrder.length) {
            return;
        }
        if (nextOrder.join(",") === previousOrder.join(",")) {
            return;
        }

        fetch(reorderUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                classId: tbody.dataset.classId,
                orderedIds: nextOrder,
            }),
        })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error("Gagal menyimpan urutan.");
                }
                return response.json();
            })
            .then(function (data) {
                if (!data || !data.success) {
                    throw new Error((data && data.message) || "Gagal menyimpan urutan.");
                }
                tbody.dataset.order = nextOrder.join(",");
            })
            .catch(function (error) {
                if (previousOrder.length) {
                    applyOrder(tbody, previousOrder);
                    updateSequenceLabels(tbody);
                }
                window.alert("Gagal menyimpan urutan siswa: " + error.message);
            });
    }

    var draggingRow = null;

    function handleDragStart(event) {
        var handle = event.target && event.target.closest(".drag-handle");
        if (!handle) {
            event.preventDefault();
            return;
        }
        draggingRow = event.currentTarget;
        dragInProgress = true;
        draggingRow.classList.add("dragging");
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", draggingRow.dataset.studentId || "");
    }

    function handleDragOver(event) {
        if (!draggingRow) {
            return;
        }
        event.preventDefault();
        var targetRow = event.currentTarget;
        if (targetRow === draggingRow) {
            return;
        }
        var tbody = targetRow.parentNode;
        var rect = targetRow.getBoundingClientRect();
        var offset = event.clientY - rect.top;
        var after = offset > rect.height / 2;
        if (after) {
            tbody.insertBefore(draggingRow, targetRow.nextSibling);
        } else {
            tbody.insertBefore(draggingRow, targetRow);
        }
    }

    function handleDragEnd() {
        if (!draggingRow) {
            dragInProgress = false;
            return;
        }
        var tbody = draggingRow.parentNode;
        draggingRow.classList.remove("dragging");
        draggingRow = null;
        updateSequenceLabels(tbody);
        persistOrder(tbody);
        setTimeout(function () {
            dragInProgress = false;
        }, 0);
    }

    function handleDrop(event) {
        event.preventDefault();
    }

    var reorderBodies = document.querySelectorAll("tbody[data-class-id]");
    reorderBodies.forEach(function (tbody) {
        var rows = tbody.querySelectorAll("tr[data-student-id]");
        if (!rows.length) {
            return;
        }
        tbody.dataset.order = getOrder(tbody).join(",");
        rows.forEach(function (row) {
            row.addEventListener("dragstart", handleDragStart);
            row.addEventListener("dragover", handleDragOver);
            row.addEventListener("dragend", handleDragEnd);
            row.addEventListener("drop", handleDrop);
        });
    });

    var dragHandles = document.querySelectorAll(".drag-handle");
    dragHandles.forEach(function (handle) {
        handle.addEventListener("click", function (event) {
            event.stopPropagation();
        });
        handle.addEventListener("mousedown", function (event) {
            event.stopPropagation();
        });
    });
});
</script>
{% endblock %}
